<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stat-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; padding: 2rem; margin-bottom: 2rem; }
    .chart-container { position: relative; height: 300px; width: 100%; }
    .nav-btn:hover { background-color: #1e293b; color: #3b82f6; }
</style>

<div class="animate-fadeIn space-y-8 pb-10">
    <section class="stat-card">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h3 class="text-xl font-black text-yellow-400 flex items-center gap-2">
                    ğŸ“Š Monthly Statistics (<span id="txtMonth"></span>)
                </h3>
            </div>
            <div class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="changeStatPeriod('month', -1)" class="nav-btn px-3 py-1 text-slate-400 transition rounded-md text-xs font-black">PREV MONTH</button>
                <button onclick="changeStatPeriod('month', 1)" class="nav-btn px-3 py-1 text-slate-400 transition rounded-md text-xs font-black ml-1">NEXT MONTH</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
        </div>
    </section>

    <section class="stat-card">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h3 class="text-xl font-black text-yellow-400 flex items-center gap-2">
                    ğŸ“Š Yearly Statistics (<span id="txtYear"></span>)
                </h3>
            </div>
            <div class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="changeStatPeriod('year', -1)" class="nav-btn px-3 py-1 text-slate-400 transition rounded-md text-xs font-black">PREV YEAR</button>
                <button onclick="changeStatPeriod('year', 1)" class="nav-btn px-3 py-1 text-slate-400 transition rounded-md text-xs font-black ml-1">NEXT YEAR</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="yearlyChart"></canvas>
        </div>
    </section>

    <section class="stat-card">
        <h3 class="text-xl font-black text-yellow-400 mb-6 flex items-center gap-2">
            ğŸŒ Overall Statistics
        </h3>
        <div class="chart-container">
            <canvas id="overallChart"></canvas>
        </div>
    </section>
</div>

<script>
    (function() {
        const db = firebase.database();
        let monthViewDate = new Date(); 
        let yearViewDate = new Date();
        
        const typeColors = {
            'ATT': '#10b981', 'LATE': '#f43f5e', 'WO': '#3b82f6', 'PEL': '#eab308',
            'ANL': '#f97316', 'HAL': '#a855f7', 'SIL': '#2dd4bf', 'SPL': '#64748b', 'EVL': '#475569'
        };

        let charts = { month: null, year: null, overall: null };
        let cachedData = null;

        window.changeStatPeriod = function(type, offset) {
            if(type === 'month') monthViewDate.setMonth(monthViewDate.getMonth() + offset);
            else if(type === 'year') yearViewDate.setFullYear(yearViewDate.getFullYear() + offset);
            processAndRender();
        };

        // í•µì‹¬ ìˆ˜ì •: ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ë Œë”ë§
        async function initStats() {
            try {
                const snap = await db.ref('attendance').once('value');
                cachedData = snap.val() || {};
                
                // ë°ì´í„°ëŠ” ê°€ì ¸ì™”ìœ¼ë‚˜, í™”ë©´ì— ì°¨íŠ¸ ì˜ì—­ì´ ë³´ì¼ ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ë Œë”ë§
                if (document.getElementById('monthlyChart')) {
                    processAndRender();
                }
            } catch (e) {
                console.error("Stats Init Error:", e);
            }
        }

        function processAndRender() {
            if (!cachedData) return;

            // ë Œë”ë§ ì‹œì ì— ìš”ì†Œê°€ ì—†ìœ¼ë©´(íƒ­ì´ ì•„ì§ ìƒì„± ì•ˆë¨) ì¤‘ë‹¨
            if (!document.getElementById('monthlyChart')) return;

            const monthKey = monthViewDate.toISOString().substring(0, 7);
            const yearKey = yearViewDate.getFullYear().toString();
            
            document.getElementById('txtMonth').innerText = monthViewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('txtYear').innerText = yearKey;

            const stats = { month: {}, year: {}, overall: {} };

            Object.entries(cachedData).forEach(([date, dayData]) => {
                Object.entries(dayData).forEach(([user, record]) => {
                    let type = "";
                    if (typeof record === 'string') type = record;
                    else if (record.attend) {
                        if (record.attend.includes("ATT")) type = "ATT";
                        else if (record.attend.includes("LATE")) type = "LATE";
                    }
                    if (!type || !typeColors[type]) return;

                    const updateCount = (obj) => {
                        if (!obj[user]) obj[user] = {};
                        obj[user][type] = (obj[user][type] || 0) + 1;
                    };

                    if (date.startsWith(monthKey)) updateCount(stats.month);
                    if (date.startsWith(yearKey)) updateCount(stats.year);
                    updateCount(stats.overall);
                });
            });

            renderChart('monthlyChart', 'month', stats.month);
            renderChart('yearlyChart', 'year', stats.year);
            renderChart('overallChart', 'overall', stats.overall);
        }

        function renderChart(canvasId, chartType, chartData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const users = Object.keys(chartData).sort();
            const types = Object.keys(typeColors);

            const datasets = types.map(type => ({
                label: type,
                data: users.map(user => chartData[user][type] || 0),
                backgroundColor: typeColors[type],
                borderRadius: 4
            }));

            if (charts[chartType]) charts[chartType].destroy();

            // Chart ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ ìµœì¢… í™•ì¸
            if (typeof Chart === 'undefined') return;

            charts[chartType] = new Chart(ctx, {
                type: 'bar',
                data: { labels: users, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // --- ìë™ ê°ì§€ ë¡œì§ ì¶”ê°€ ---
        // íƒ­ì´ ìˆ¨ê²¨ì ¸ ìˆë‹¤ê°€ ë‚˜íƒ€ë‚  ë•Œ(classì— 'hidden'ì´ ë¹ ì§ˆ ë•Œ ë“±)ë¥¼ ê°ì§€
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class' || mutation.attributeName === 'style') {
                    processAndRender();
                }
            });
        });

        // ì´ˆê¸° ì‹¤í–‰ ë° ê´€ì°° ì‹œì‘
        setTimeout(() => {
            initStats();
            const container = document.querySelector('.animate-fadeIn');
            if (container) observer.observe(container, { attributes: true });
        }, 300);

        // ì „ì—­ ì ‘ê·¼ í—ˆìš©
        window.refreshStatistics = processAndRender;
    })();
</script>