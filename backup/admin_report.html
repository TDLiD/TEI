<div class="animate-fadeIn space-y-6">
    <div class="bg-slate-900/50 p-6 rounded-[32px] border border-slate-800 shadow-2xl backdrop-blur-sm">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black text-white flex items-center gap-3">
                <div class="w-2 h-8 bg-emerald-500 rounded-full"></div>
                WORK REPORTS <span class="text-emerald-500/50 font-light text-lg uppercase tracking-widest hidden md:inline">Calendar</span>
            </h2>
            
            <div class="flex items-center gap-4 bg-slate-800/50 p-1.5 rounded-2xl border border-slate-700/50">
                <button onclick="window.changeWorkMonth(-1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div id="full_work_month" class="text-sm font-black text-white px-2 min-w-[140px] text-center tracking-tighter"></div>
                <button onclick="window.changeWorkMonth(1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <div class="overflow-x-auto rounded-2xl border border-slate-800 shadow-inner bg-slate-950/20">
            <table class="w-full table-fixed border-collapse min-w-[700px]">
                <thead>
                    <tr class="text-slate-500 text-[11px] font-black uppercase tracking-widest bg-slate-800/30">
                        <th class="py-4 border-b border-slate-800 text-red-400/80 font-black">Sun</th>
                        <th class="py-4 border-b border-slate-800">Mon</th>
                        <th class="py-4 border-b border-slate-800">Tue</th>
                        <th class="py-4 border-b border-slate-800">Wed</th>
                        <th class="py-4 border-b border-slate-800">Thu</th>
                        <th class="py-4 border-b border-slate-800">Fri</th>
                        <th class="py-4 border-b border-slate-800 text-blue-400/80">Sat</th>
                    </tr>
                </thead>
                <tbody id="full_work_calendar_body"></tbody>
            </table>
        </div>
    </div>
</div>

<style>
    #full_work_calendar_body td { 
        height: 140px; 
        border: 1px solid rgba(30, 41, 59, 0.5); 
        vertical-align: top; 
        padding: 8px;
        transition: background-color 0.2s;
    }
    #full_work_calendar_body td:hover {
        background-color: rgba(30, 41, 59, 0.2);
    }
    .work-item {
        font-size: 10px;
        font-weight: 800;
        padding: 4px 6px;
        border-radius: 8px;
        margin-bottom: 3px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
    }
    .work-item:hover { 
        filter: brightness(1.2); 
        transform: translateY(-1px) scale(1.02);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .work-item:active { transform: scale(0.98); }
</style>

<script>
    (function() {
        let viewDate = new Date();
        const db = firebase.database();

        // 관리자 메모 저장 함수
        window.saveAdminMemo = function(date, name) {
            const memoValue = document.getElementById('adminMemoInput').value;
            db.ref(`reports/${date}/${name}`).update({
                adminMemo: memoValue
            }).then(() => {
                alert('Admin memo saved successfully!');
            }).catch(err => {
                console.error(err);
                alert('Save failed.');
            });
        };

        // [수정] 팝업창(모달) 상세 디자인 함수 - 메모 필드 추가
        window.showWorkDetail = function(name, date, status, contentEncoded, memoEncoded) {
            const content = decodeURIComponent(contentEncoded);
            const memo = decodeURIComponent(memoEncoded || '');
            
            let statusBadge = "";
            if(status === 'Completed') {
                statusBadge = `<span class="bg-emerald-500 text-slate-900 px-3 py-1 rounded-full text-[10px] font-black border border-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.3)]">COMPLETED</span>`;
            } else if(status === 'Pending') {
                statusBadge = `<span class="bg-amber-500 text-slate-900 px-3 py-1 rounded-full text-[10px] font-black border border-amber-400 shadow-[0_0_15px_rgba(245,158,11,0.3)]">PENDING</span>`;
            } else {
                statusBadge = `<span class="bg-blue-500 text-slate-900 px-3 py-1 rounded-full text-[10px] font-black border border-blue-400 shadow-[0_0_15px_rgba(59,130,246,0.3)]">IN PROGRESS</span>`;
            }

            const titleHtml = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center text-slate-900 font-black text-lg shadow-lg">
                        ${name.charAt(0)}
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            ${statusBadge}
                            <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">${date}</span>
                        </div>
                        <div class="text-xl font-black text-white tracking-tight">${name}'s Report</div>
                    </div>
                </div>`;

            const bodyHtml = `
                <div class="space-y-5 animate-fadeIn">
                    <div class="relative">
                        <div class="absolute -top-3 left-4 bg-slate-900 px-2 text-[10px] font-black text-emerald-500 tracking-widest uppercase">Content Summary</div>
                        <div class="p-5 bg-slate-950/80 rounded-[24px] border border-slate-800 text-sm text-slate-300 leading-relaxed whitespace-pre-wrap min-h-[100px] shadow-inner">
                            ${content || '<span class="text-slate-600 italic">No content provided.</span>'}
                        </div>
                    </div>

                    <div class="relative">
                        <div class="absolute -top-3 left-4 bg-slate-900 px-2 text-[10px] font-black text-blue-400 tracking-widest uppercase">Admin Management Memo</div>
                        <div class="p-4 bg-slate-950/40 rounded-[24px] border border-slate-700/50 space-y-3">
                            <textarea id="adminMemoInput" 
                                class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-xs text-white outline-none focus:border-blue-500 transition-all min-h-[80px] resize-none" 
                                placeholder="Enter admin notes here...">${memo}</textarea>
                            <button onclick="window.saveAdminMemo('${date}', '${name}')" 
                                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black text-[10px] py-2.5 rounded-xl transition-all uppercase tracking-widest shadow-lg shadow-blue-900/20 active:scale-95">
                                Save Admin Memo
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-800/30 rounded-2xl border border-slate-700/50 flex flex-col items-center">
                            <span class="text-[9px] text-slate-500 font-black uppercase mb-1">Reporter</span>
                            <span class="text-xs text-white font-bold">${name}</span>
                        </div>
                        <div class="p-3 bg-slate-800/30 rounded-2xl border border-slate-700/50 flex flex-col items-center">
                            <span class="text-[9px] text-slate-500 font-black uppercase mb-1">Last Update</span>
                            <span class="text-xs text-white font-bold">${date.split('-')[1]}/${date.split('-')[2]}</span>
                        </div>
                    </div>
                </div>`;

            if (typeof window.openAdminCustomModal === 'function') {
                window.openAdminCustomModal(titleHtml, bodyHtml);
            } else {
                alert(`${name} Report: ${content}`);
            }
        };

        window.renderWorkFull = function() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            
            document.getElementById('full_work_month').innerText = viewDate.toLocaleString('en-US', {month:'long', year:'numeric'}).toUpperCase();

            db.ref('reports').off();
            db.ref('reports').on('value', snap => {
                const data = snap.val() || {};
                const tbody = document.getElementById('full_work_calendar_body');
                tbody.innerHTML = '';

                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                
                let dateNum = 1;
                for (let i = 0; i < 6; i++) {
                    let tr = document.createElement('tr');
                    let hasCells = false;

                    for (let j = 0; j < 7; j++) {
                        let td = document.createElement('td');
                        if (i === 0 && j < firstDay || dateNum > lastDate) {
                            td.innerHTML = "";
                            td.classList.add('bg-slate-900/10');
                        } else {
                            hasCells = true;
                            const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dateNum).padStart(2, '0')}`;
                            const isToday = new Date().toLocaleDateString('sv-SE') === dStr;
                            
                            let html = `<div class="flex justify-between items-center mb-2">
                                <span class="text-[11px] font-black ${isToday ? 'bg-emerald-500 text-slate-900 w-5 h-5 flex items-center justify-center rounded-full' : (j === 0 ? 'text-red-500' : (j === 6 ? 'text-blue-400' : 'text-slate-500'))}">${dateNum}</span>
                            </div>`;
                            
                            const dayReports = data[dStr] || {};
                            let reportHtml = '<div class="space-y-1.5">';
                            Object.entries(dayReports).forEach(([name, report]) => {
                                const statusColor = report.status === 'Completed' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 
                                                  (report.status === 'Pending' ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : 'bg-blue-500/10 text-blue-400 border-blue-500/20');
                                
                                const safeContent = encodeURIComponent(report.content || '');
                                const safeMemo = encodeURIComponent(report.adminMemo || '');
                                
                                reportHtml += `
                                    <div onclick="window.showWorkDetail('${name}', '${dStr}', '${report.status}', '${safeContent}', '${safeMemo}')" 
                                         class="work-item border ${statusColor}">
                                        ${name}
                                    </div>`;
                            });
                            reportHtml += '</div>';
                            
                            td.innerHTML = html + reportHtml;
                            dateNum++;
                        }
                        tr.appendChild(td);
                    }
                    if (!hasCells) break;
                    tbody.appendChild(tr);
                }
            });
        };

        window.changeWorkMonth = (offset) => {
            viewDate.setMonth(viewDate.getMonth() + offset);
            window.renderWorkFull();
        };

        window.renderWorkFull();
    })();
</script>