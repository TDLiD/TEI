<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - DAILY SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css">
    <style>
        body { font-family: "Pretendard", sans-serif; background-color: #000; color: #f1f5f9; }
        .tab-btn { transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 900; }
        .tab-inactive { color: #64748b; }
        
        @keyframes toast-in {
            from { transform: translateX(100%) scale(0.9); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        .animate-toast { animation: toast-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 relative">

    <div id="globalNotificationArea" class="fixed top-6 right-6 z-[10000] flex flex-col gap-3 w-[320px] pointer-events-none"></div>

    <div class="max-w-[1400px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-slate-800 pb-6 gap-6">
            <h1 class="text-3xl font-black italic tracking-tighter">ADMIN <span class="text-blue-500">SYSTEM</span></h1>
            <nav class="flex gap-6 md:gap-10 overflow-x-auto no-scrollbar max-w-full pb-2 md:pb-0">
                <button onclick="switchAdminTab('dashboard')" id="btn-dashboard" class="tab-btn pb-2 uppercase tracking-widest text-sm tab-active whitespace-nowrap">Dashboard</button>
                <button onclick="switchAdminTab('attendance')" id="btn-attendance" class="tab-btn pb-2 uppercase tracking-widest text-sm tab-inactive whitespace-nowrap">Attendance</button>
                <button onclick="switchAdminTab('reports')" id="btn-reports" class="tab-btn pb-2 uppercase tracking-widest text-sm tab-inactive whitespace-nowrap">Work Reports</button>
                <button onclick="switchAdminTab('schedule')" id="btn-schedule" class="tab-btn pb-2 uppercase tracking-widest text-sm tab-inactive whitespace-nowrap text-purple-400">Schedule</button>
            </nav>
            <a href="index.html" class="text-xs font-bold text-slate-500 hover:text-white transition uppercase tracking-widest border border-slate-800 px-4 py-2 rounded-full">Logout</a>
        </header>

        <div id="adminContent" class="animate-fadeIn"></div>
    </div>

    <div id="customAdminModal" class="fixed inset-0 z-[9999] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-md" onclick="window.closeAdminCustomModal()"></div>
        <div class="relative bg-slate-900 w-full max-w-md rounded-[32px] border border-slate-700 shadow-2xl overflow-hidden">
            <div id="modalHeaderArea" class="p-6 pb-4 border-b border-slate-800/50"></div>
            <div id="modalBodyArea" class="p-6 max-h-[60vh] overflow-y-auto"></div>
            <div class="p-6 pt-0">
                <button onclick="window.closeAdminCustomModal()" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl">Close</button>
            </div>
        </div>
    </div>

<script>
        // 1. ì´ˆê¸°í™”
        const firebaseConfig = { databaseURL: "https://tdlid-dailyreport-default-rtdb.firebaseio.com" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let isInitialLoad = true; 

        // 2. ì•Œë¦¼ ìƒì„± í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
        function createNotification(type, user, period, content) {
            console.log(`[Notification] ${type} from ${user}`); 
            const area = document.getElementById('globalNotificationArea');
            if(!area) return;

            const toast = document.createElement('div');
            const config = {
                'ATTENDANCE': { color: 'blue', icon: 'ğŸ‘¤' },
                'WORK REPORT': { color: 'emerald', icon: 'ğŸ“' },
                'SCHEDULE': { color: 'purple', icon: 'ğŸ“…' }
            }[type] || { color: 'slate', icon: 'ğŸ””' };

            toast.className = `animate-toast pointer-events-auto bg-slate-950 border-l-4 border-${config.color}-500 shadow-[0_20px_50px_rgba(0,0,0,0.5)] p-4 rounded-r-2xl border border-slate-800 flex flex-col gap-1 cursor-pointer hover:bg-slate-900 transition-all`;
            toast.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] font-black text-${config.color}-400 tracking-tighter uppercase">${config.icon} ${type}</span>
                    <span class="text-[9px] text-slate-600 font-bold">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="text-xs font-black text-white">${user} <span class="text-slate-500 font-medium">ìƒˆ í•­ëª© ë“±ë¡</span></div>
                <div class="text-[10px] text-slate-400 font-bold italic">${period}</div>
                <div class="text-[11px] text-slate-300 bg-black/40 p-2 rounded-lg line-clamp-2 border border-white/5 mt-1">${content}</div>
            `;

            toast.onclick = () => toast.remove();
            area.appendChild(toast);
            setTimeout(() => { if(toast.parentElement) toast.remove(); }, 8000);
        }

        // 3. ê°•ë ¥í•œ ì‹¤ì‹œê°„ ê°ì‹œ ë¡œì§ (Deep Watch)
        function startRealtimeWatch() {
            console.log("Deep Watch Started...");

            // [ì¶œí‡´ê·¼ ê°ì‹œ] ë‚ ì§œ ê²½ë¡œë¥¼ ê±´ë„ˆë›°ê³  ì „ì²´ íƒìƒ‰ (ref('attendance'))
            db.ref('attendance').on('child_added', (dateSnap) => {
                // ìƒˆë¡œìš´ ë‚ ì§œ í´ë”ê°€ ìƒê¸¸ ë•Œ ê·¸ ì•ˆì˜ ìì‹ë“¤ì„ ê°ì‹œ
                dateSnap.ref.on('child_added', (snap) => {
                    if (isInitialLoad) return;
                    const data = snap.val();
                    const status = typeof data === 'string' ? data : (data.attend || "ì¶œê·¼ ê¸°ë¡");
                    createNotification('ATTENDANCE', snap.key, dateSnap.key, status);
                });
                dateSnap.ref.on('child_changed', (snap) => {
                    if (isInitialLoad) return;
                    const data = snap.val();
                    if(data.leave) createNotification('ATTENDANCE', snap.key, dateSnap.key, "í‡´ê·¼ ì™„ë£Œ: " + data.leave);
                });
            });

            // [ì—…ë¬´ë³´ê³  ê°ì‹œ] ì „ì²´ íƒìƒ‰ (ref('reports'))
            db.ref('reports').on('child_added', (dateSnap) => {
                dateSnap.ref.on('child_added', (snap) => {
                    if (isInitialLoad) return;
                    const data = snap.val();
                    createNotification('WORK REPORT', snap.key, dateSnap.key, data.content || "ë‚´ìš© ì—†ìŒ");
                });
                dateSnap.ref.on('child_changed', (snap) => {
                    if (isInitialLoad) return;
                    const data = snap.val();
                    createNotification('WORK REPORT', snap.key + " (ìˆ˜ì •)", dateSnap.key, data.content || "ìˆ˜ì •ë¨");
                });
            });

            // [ìŠ¤ì¼€ì¤„ ê°ì‹œ]
            db.ref('shared_schedules').on('child_added', (snap) => {
                if (isInitialLoad) return;
                const data = snap.val();
                createNotification('SCHEDULE', data.author || "ì‚¬ìš©ì", data.start || "No Date", data.title);
            });
        }

        // ì´ˆê¸° ë¡œë”© ì‹œ ê¸°ì¡´ ë°ì´í„° ë¬´ì‹œë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
        startRealtimeWatch();
        setTimeout(() => {
            isInitialLoad = false;
            console.log("Realtime Notifications Active.");
        }, 3000);

        // --- íƒ­ ë° ëª¨ë‹¬ ê´€ë¦¬ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼) ---
        window.openAdminCustomModal = function(titleHtml, bodyHtml) {
            document.getElementById('modalHeaderArea').innerHTML = titleHtml;
            document.getElementById('modalBodyArea').innerHTML = bodyHtml;
            document.getElementById('customAdminModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; 
        };
        window.closeAdminCustomModal = function() {
            document.getElementById('customAdminModal').classList.add('hidden');
            document.body.style.overflow = ''; 
        };

        async function switchAdminTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('tab-inactive');
            });
            const activeBtn = document.getElementById(`btn-${tab}`);
            if (activeBtn) {
                activeBtn.classList.add('tab-active');
                activeBtn.classList.remove('tab-inactive');
            }

            const fileMap = {
                'dashboard': 'admin_dashboard.html',
                'attendance': 'admin_attendance.html',
                'reports': 'admin_report.html',
                'schedule': 'admin_schedule.html'
            };
            const targetFile = fileMap[tab];

            try {
                const response = await fetch(targetFile);
                const html = await response.text();
                const contentArea = document.getElementById('adminContent');
                contentArea.innerHTML = html;

                const scripts = contentArea.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

                setTimeout(() => {
                    if (tab === 'dashboard') window.initAdminDashboard?.();
                    else if (tab === 'attendance') window.renderAttendanceFull?.();
                    else if (tab === 'reports') window.renderWorkFull?.();
                    else if (tab === 'schedule') window.renderScheduleFull?.();
                }, 200);
            } catch (e) { console.error(e); }
        }

        window.onload = () => switchAdminTab('dashboard');
    </script>


</body>
</html>