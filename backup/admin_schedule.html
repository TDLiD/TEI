<div class="animate-fadeIn space-y-6">
    <div class="bg-slate-900/50 p-6 rounded-[32px] border border-slate-800 shadow-2xl backdrop-blur-sm">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black text-white flex items-center gap-3">
                <div class="w-2 h-8 bg-purple-500 rounded-full"></div>
                STAFF SCHEDULE <span class="text-purple-500/50 font-light text-lg uppercase tracking-widest hidden md:inline">Master</span>
            </h2>
            
            <div class="flex items-center gap-4 bg-slate-800/50 p-1.5 rounded-2xl border border-slate-700/50">
                <button onclick="window.changeSchMonth(-1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div id="full_sch_month" class="text-sm font-black text-white px-2 min-w-[140px] text-center tracking-tighter uppercase"></div>
                <button onclick="window.changeSchMonth(1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/20">
            <table class="w-full table-fixed border-collapse min-w-[700px]">
                <thead>
                    <tr class="text-slate-500 text-[11px] font-black uppercase tracking-widest bg-slate-800/30">
                        <th class="py-4 border-b border-slate-800 text-red-400/80">Sun</th>
                        <th class="py-4 border-b border-slate-800">Mon</th>
                        <th class="py-4 border-b border-slate-800">Tue</th>
                        <th class="py-4 border-b border-slate-800">Wed</th>
                        <th class="py-4 border-b border-slate-800">Thu</th>
                        <th class="py-4 border-b border-slate-800">Fri</th>
                        <th class="py-4 border-b border-slate-800 text-blue-400/80">Sat</th>
                    </tr>
                </thead>
                <tbody id="full_sch_calendar_body"></tbody>
            </table>
        </div>
    </div>
</div>

<style>
    #full_sch_calendar_body td { height: 130px; border: 0.5px solid rgba(30, 41, 59, 0.5); vertical-align: top; padding: 6px; }
    .sch-item {
        font-size: 9px; font-weight: 800; padding: 3px 6px; border-radius: 6px; margin-bottom: 2px;
        cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        transition: all 0.2s; border-left: 3px solid rgba(168, 85, 247, 0.5);
    }
    .sch-item:hover { filter: brightness(1.2); transform: translateX(2px); }
</style>

<script>
(function() {
    let viewDate = new Date();
    const db = firebase.database();

    // --- 일정 상세 팝업 (디자인 + 메모 기능) ---
    window.showAdminSchDetail = function(id, title, start, end, author, descEncoded, memoEncoded) {
        const desc = decodeURIComponent(descEncoded);
        const memo = decodeURIComponent(memoEncoded || '');
        
        const titleHtml = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-400 font-black text-xs border border-purple-500/20">SCH</div>
                <div>
                    <div class="text-[11px] text-slate-500 font-bold uppercase tracking-tighter italic">Schedule Management</div>
                    <div class="text-lg font-black text-white leading-tight">${title}</div>
                </div>
            </div>`;

        const bodyHtml = `
            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-slate-800/30 rounded-xl border border-slate-700/50">
                        <div class="text-[9px] text-slate-500 font-black uppercase mb-1">Created By</div>
                        <div class="text-xs text-white font-bold">${author}</div>
                    </div>
                    <div class="p-3 bg-slate-800/30 rounded-xl border border-slate-700/50">
                        <div class="text-[9px] text-slate-500 font-black uppercase mb-1">Period</div>
                        <div class="text-[10px] text-slate-300 font-bold">${start.split('T')[0]} ~ ${end.split('T')[0]}</div>
                    </div>
                </div>
                
                <div class="space-y-1">
                    <div class="text-[10px] text-slate-500 font-black uppercase pl-1">Description</div>
                    <div class="p-4 bg-slate-950/50 rounded-2xl border border-slate-800 text-sm text-slate-300 leading-relaxed min-h-[60px] shadow-inner">
                        ${desc || 'No description provided.'}
                    </div>
                </div>

                <div class="space-y-1">
                    <div class="text-[10px] text-purple-400 font-black uppercase pl-1">Admin Memo</div>
                    <textarea id="admin_memo_input" placeholder="Enter private admin memo here..." 
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-2xl p-4 text-sm text-white focus:outline-none focus:border-purple-500 transition-colors h-24 resize-none shadow-inner">${memo}</textarea>
                </div>

                <button onclick="window.saveAdminMemo('${id}')" 
                    class="w-full bg-purple-600 hover:bg-purple-500 text-white font-black py-3 rounded-xl transition-all active:scale-95 shadow-lg shadow-purple-500/20 text-xs tracking-widest uppercase">
                    Save Memo
                </button>
            </div>`;

        window.openAdminCustomModal(titleHtml, bodyHtml);
    };

    // --- 메모 저장 함수 ---
    window.saveAdminMemo = function(schId) {
        const memoValue = document.getElementById('admin_memo_input').value;
        db.ref('shared_schedules/' + schId).update({
            adminMemo: memoValue
        }).then(() => {
            alert('Memo saved successfully!');
            window.closeAdminCustomModal();
            window.renderScheduleFull();
        });
    };

    // --- 캘린더 렌더링 ---
    window.renderScheduleFull = function() {
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        document.getElementById('full_sch_month').innerText = viewDate.toLocaleString('en-US', {month:'long', year:'numeric'});

        db.ref('shared_schedules').on('value', snap => {
            const data = snap.val() || {};
            const tbody = document.getElementById('full_sch_calendar_body');
            tbody.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            let dateNum = 1;

            for (let i = 0; i < 6; i++) {
                let tr = document.createElement('tr');
                let hasCells = false;
                for (let j = 0; j < 7; j++) {
                    let td = document.createElement('td');
                    if (i === 0 && j < firstDay || dateNum > lastDate) {
                        td.innerHTML = "";
                    } else {
                        hasCells = true;
                        const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dateNum).padStart(2, '0')}`;
                        let html = `<div class="text-[10px] font-black mb-2 ${j === 0 ? 'text-red-500' : 'text-slate-500'}">${dateNum}</div>`;
                        
                        let schHtml = '<div class="space-y-1">';
                        Object.entries(data).forEach(([id, ev]) => {
                            const start = ev.start ? ev.start.split('T')[0] : "";
                            const end = ev.end ? ev.end.split('T')[0] : "";
                            if (dStr >= start && dStr <= end) {
                                const safeDesc = encodeURIComponent(ev.desc || ev.description || '');
                                const safeMemo = encodeURIComponent(ev.adminMemo || '');
                                const author = ev.author || 'User';
                                const hasMemo = ev.adminMemo ? 'bg-purple-500/30' : 'bg-slate-800/40 text-slate-300';
                                
                                schHtml += `
                                    <div onclick="window.showAdminSchDetail('${id}', '${ev.title}', '${ev.start}', '${ev.end}', '${author}', '${safeDesc}', '${safeMemo}')" 
                                         class="sch-item ${hasMemo} border border-slate-700/50">
                                        <span class="opacity-60 text-[8px]">${author.charAt(0)}</span> ${ev.title}
                                    </div>`;
                            }
                        });
                        schHtml += '</div>';
                        td.innerHTML = html + schHtml;
                        dateNum++;
                    }
                    tr.appendChild(td);
                }
                if (!hasCells) break;
                tbody.appendChild(tr);
            }
        });
    };

    window.changeSchMonth = (offset) => {
        viewDate.setMonth(viewDate.getMonth() + offset);
        window.renderScheduleFull();
    };

    window.renderScheduleFull();
})();
</script>