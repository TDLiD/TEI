<style>
    /* 상하단 달력 크기를 맞추기 위한 스타일 통일 */
    .mini-cal th { padding: 10px 0; color: #64748b; font-size: 0.8rem; text-transform: uppercase; }
    .mini-cal td { 
        height: 70px; width: 14.28%; border: 1px solid #1e293b; vertical-align: top; padding: 6px; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .mini-cal td:hover { background-color: #1e293b; }
    
    .selected-date { background-color: rgba(59, 130, 246, 0.15) !important; border: 2px solid #3b82f6 !important; }
    .selected-date .date-num { color: #3b82f6; font-weight: 900; }

    .report-card-fixed { max-width: 400px; width: 100%; }
    .nav-btn:hover { background-color: #1e293b; color: #3b82f6; }

    /* 상태 표시 공통 스타일 */
    .status-tag {
        position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
        font-size: 8px; font-weight: 900; padding: 2px 5px; border-radius: 4px;
        white-space: nowrap; pointer-events: none;
    }
    
    .status-progress { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-completed { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .status-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
</style>

<div class="animate-fadeIn flex flex-col lg:flex-row gap-6 items-start">
    <div class="report-card-fixed">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white">Work Detail</h3>
            <div id="actionButtons"></div>
        </div>

        <div id="workCardContainer">
            <div class="text-slate-500 animate-pulse text-sm">Loading...</div>
        </div>
    </div>

    <div class="flex-1 w-full"> 
        <div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl">
            <div class="flex justify-between items-center mb-4 px-1">
                <div class="flex items-center gap-4">
                    <div id="miniCalMonth" class="text-lg font-black text-white italic"></div>
                    <div class="flex bg-slate-800 rounded-lg p-1">
                        <button onclick="window.changeViewMonth(-1)" class="nav-btn px-2 py-1 text-slate-400 transition rounded-md text-[10px] font-black">PREV</button>
                        <button onclick="window.goToday()" class="nav-btn px-2 py-1 text-blue-400 transition rounded-md text-[10px] font-black mx-1">TODAY</button>
                        <button onclick="window.changeViewMonth(1)" class="nav-btn px-2 py-1 text-slate-400 transition rounded-md text-[10px] font-black">NEXT</button>
                    </div>
                </div>
                <span class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">Select Date</span>
            </div>
            <table class="mini-cal w-full border-collapse">
                <thead>
                    <tr class="text-slate-500">
                        <th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th>
                    </tr>
                </thead>
                <tbody id="miniCalBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    (function() {
        const user = sessionStorage.getItem('loggedInUser');
        const database = firebase.database();
        let viewDate = new Date();
        const todayStr = new Date().toISOString().split('T')[0];
        let selectedDateStr = todayStr;
        let currentReportData = null; // 현재 불러온 리포트 원본 보관용

        window.changeViewMonth = function(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderMiniCalendar();
        };

        window.goToday = function() {
            viewDate = new Date();
            selectedDateStr = todayStr;
            loadReport(selectedDateStr);
        };

        // 리포트 저장/수정 함수
        window.saveReport = function() {
            const contentField = document.getElementById('editContent');
            const statusField = document.getElementById('editStatus');
            
            if(!contentField || !contentField.value.trim()) {
                return alert("Please enter work content.");
            }

            const content = contentField.value;
            const status = statusField.value;
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

            const saveData = {
                content: String(content),
                status: status,
                time: timeStr
            };

            // [핵심] 기존에 adminMemo가 있었다면 유실되지 않도록 포함
            if (currentReportData && currentReportData.adminMemo) {
                saveData.adminMemo = currentReportData.adminMemo;
            }

            database.ref('reports/' + selectedDateStr + '/' + user).set(saveData).then(() => {
                alert("Saved successfully.");
                loadReport(selectedDateStr);
            }).catch((error) => {
                console.error("Save Error:", error);
                alert("Failed to save.");
            });
        };

        // 1. 편집 모드 전환 함수 (관리자 메모 칸은 노출하지 않음)
        window.showEditor = function() {
            document.getElementById('actionButtons').innerHTML = '';
            const container = document.getElementById('workCardContainer');
            
            // 현재 보관된 데이터가 없으면 기본값 설정
            const report = currentReportData || { content: "", status: "In Progress" };
            
            container.innerHTML = `
                <div class="bg-slate-900 p-6 rounded-2xl border border-blue-500/50 shadow-lg animate-fadeIn">
                    <div class="mb-4">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Status</label>
                        <select id="editStatus" class="w-full bg-slate-800 text-white p-2 rounded-xl border border-slate-700 outline-none text-sm">
                            <option value="In Progress" ${report.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Completed" ${report.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Pending" ${report.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Work Content</label>
                        <textarea id="editContent" class="w-full bg-slate-800 text-white p-4 rounded-xl border border-slate-700 outline-none text-sm min-h-[200px] resize-none focus:border-blue-500 transition">${report.content}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.loadReport('${selectedDateStr}')" class="bg-slate-700 text-white py-3 rounded-xl text-xs font-bold hover:bg-slate-600 transition">Cancel</button>
                        <button onclick="window.saveReport()" class="bg-blue-600 text-white py-3 rounded-xl text-xs font-bold hover:bg-blue-500 transition">Save Report</button>
                    </div>
                </div>`;
        };

// 리포트 삭제 함수
        window.deleteReport = function() {
            if (!confirm("Are you sure you want to delete this report?")) return;

            database.ref('reports/' + selectedDateStr + '/' + user).remove()
                .then(() => {
                    alert("Deleted successfully.");
                    currentReportData = null; // 로컬 데이터 초기화
                    loadReport(selectedDateStr); // 화면 갱신
                })
                .catch((error) => {
                    console.error("Delete Error:", error);
                    alert("Failed to delete.");
                });
        };


        // 2. 리포트 불러오기 함수 (조회 시 관리자 메모 노출)
        window.loadReport = function(dateStr) {
            selectedDateStr = dateStr;
            renderMiniCalendar();

            const actionBtn = document.getElementById('actionButtons');
            actionBtn.innerHTML = ''; 

            database.ref('reports/' + dateStr + '/' + user).once('value', (snapshot) => {
                const report = snapshot.val();
                currentReportData = report; // 전역 변수에 저장 (수정 시 adminMemo 보존용)
                const container = document.getElementById('workCardContainer');
                
                if (!report) {
                    actionBtn.innerHTML = `<button onclick="window.showEditor()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-500 transition">+ Write</button>`;
                    container.innerHTML = `
                        <div class="bg-slate-900/50 p-10 rounded-2xl border border-dashed border-slate-800 text-center">
                            <p class="text-slate-500 text-sm italic">No report for this date.</p>
                        </div>`;
                } else {
                    actionBtn.innerHTML = `
                        <button onclick="window.deleteReport()" class="text-rose-500 hover:text-rose-400 text-xs font-bold mr-3">Delete</button>
                        <button onclick="window.showEditor()" class="bg-slate-700 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-600 transition">Edit</button>
                    `;
                    
                    // [핵심] 관리자 메모가 있는 경우 표시할 HTML 생성
                    let adminMemoHtml = "";
                    if (report.adminMemo) {
                        adminMemoHtml = `
                            <div class="mt-4 p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
                                <p class="text-[10px] font-black text-blue-400 uppercase mb-1">Admin Memo</p>
                                <p class="text-xs text-blue-200 italic leading-relaxed">${report.adminMemo}</p>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div class="bg-slate-900 p-6 rounded-2xl border ${report.status === 'Completed' ? 'border-green-900/50' : 'border-slate-800'} shadow-lg animate-fadeIn">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-blue-400 text-sm font-black font-mono">${dateStr}</span>
                                <span class="px-2 py-1 rounded-full text-[9px] font-bold ${report.status === 'Completed' ? 'bg-green-900/30 text-green-400' : 'bg-amber-900/30 text-amber-400'}">
                                    ${report.status.toUpperCase()}
                                </span>
                            </div>
                            <p class="text-slate-200 leading-relaxed whitespace-pre-wrap min-h-[150px] text-sm">${report.content}</p>
                            ${adminMemoHtml}
                            <div class="mt-4 pt-4 border-t border-slate-800 text-right">
                                <span class="text-[10px] text-slate-500 italic">Last Update: ${report.time || 'N/A'}</span>
                            </div>
                        </div>`;
                }
            });
        };

        function renderMiniCalendar() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            document.getElementById('miniCalMonth').innerText = viewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();
            
            database.ref('reports').once('value', (snapshot) => {
                const allReports = snapshot.val() || {};
                const tbody = document.getElementById('miniCalBody');
                tbody.innerHTML = '';
                
                let date = 1;
                for (let i = 0; i < 6; i++) {
                    let row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        let cell = document.createElement('td');
                        if (i === 0 && j < firstDay) {
                            row.appendChild(cell);
                        } else if (date > lastDate) {
                            row.appendChild(cell);
                        } else {
                            const curDate = date;
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(curDate).padStart(2, '0')}`;
                            let cellHTML = `<div class="date-num text-xs font-bold text-slate-500">${curDate}</div>`;
                            const userReport = (allReports[dateStr] && allReports[dateStr][user]) ? allReports[dateStr][user] : null;

                            if (userReport) {
                                let statusClass = "status-progress";
                                let statusText = "PROGRESS";
                                if (userReport.status === 'Completed') {
                                    statusClass = "status-completed";
                                    statusText = "COMPLETED";
                                } else if (userReport.status === 'Pending') {
                                    statusClass = "status-pending";
                                    statusText = "PENDING";
                                }
                                cellHTML += `<div class="status-tag ${statusClass}">${statusText}</div>`;
                            }

                            cell.innerHTML = cellHTML;
                            if (dateStr === selectedDateStr) cell.classList.add('selected-date');
                            cell.onclick = () => loadReport(dateStr);
                            row.appendChild(cell);
                            date++;
                        }
                    }
                    tbody.appendChild(row);
                    if (date > lastDate) break;
                }
            });
        }
        
        loadReport(selectedDateStr);
    })();
</script>