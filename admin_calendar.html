<div class="animate-fadeIn space-y-4 md:space-y-6">
    <div class="bg-slate-900/50 p-4 md:p-6 rounded-[24px] md:rounded-[32px] border border-slate-800 shadow-2xl backdrop-blur-sm">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-8 gap-4">
            <h2 class="text-xl md:text-2xl font-black text-white flex items-center gap-3 w-full md:w-auto">
                <div class="w-1.5 h-7 md:w-2 md:h-8 bg-purple-500 rounded-full"></div>
                STAFF SCHEDULE <span class="text-purple-500/50 font-light text-sm md:text-lg uppercase tracking-widest hidden sm:inline">Master</span>
            </h2>
            
            <div class="flex items-center gap-2 md:gap-4 bg-slate-800/50 p-1.5 rounded-2xl border border-slate-700/50 w-full md:w-auto justify-between md:justify-start">
                <div class="flex items-center gap-1">
                    <button onclick="window.changeSchMonth(-1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <button onclick="window.goTodaySch()" class="px-3 py-2 text-[10px] font-black bg-slate-700 hover:bg-purple-600 text-white rounded-lg transition-all active:scale-95 uppercase">Today</button>
                </div>

                <div id="full_sch_month" class="text-xs md:text-sm font-black text-white px-2 min-w-[100px] md:min-w-[140px] text-center tracking-tighter uppercase italic"></div>
                
                <button onclick="window.changeSchMonth(1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-950/20">
            <table class="w-full table-fixed border-collapse">
                <thead>
                    <tr class="hidden md:table-row text-slate-500 text-[11px] font-black uppercase tracking-widest bg-slate-800/30">
                        <th class="py-4 border-b border-slate-800 text-red-400/80">Sun</th>
                        <th class="py-4 border-b border-slate-800">Mon</th>
                        <th class="py-4 border-b border-slate-800">Tue</th>
                        <th class="py-4 border-b border-slate-800">Wed</th>
                        <th class="py-4 border-b border-slate-800">Thu</th>
                        <th class="py-4 border-b border-slate-800">Fri</th>
                        <th class="py-4 border-b border-slate-800 text-blue-400/80">Sat</th>
                    </tr>
                </thead>
                <tbody id="full_sch_calendar_body" class="flex flex-col md:table-row-group"></tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* 데스크톱 테이블 스타일 */
    @media (min-width: 768px) {
        #full_sch_calendar_body tr { display: table-row; height: 140px; }
        #full_sch_calendar_body td { 
            display: table-cell;
            min-height: 140px; 
            border: 0.5px solid rgba(30, 41, 59, 0.5); 
            vertical-align: top; 
            padding: 0;
            position: relative;
        }
        .date-wrapper { padding: 8px 10px; pointer-events: none; }
    }

    /* 모바일 리스트 스타일 */
    @media (max-width: 767px) {
        #full_sch_calendar_body { gap: 12px; padding: 12px; }
        #full_sch_calendar_body tr { display: contents; }
        #full_sch_calendar_body td {
            display: block;
            width: 100% !important;
            height: auto !important;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 4px;
        }
        #full_sch_calendar_body td:empty { display: none; }
        .date-wrapper { margin-bottom: 10px; pointer-events: none; }
        .sch-item { 
            position: relative !important; 
            top: 0 !important; 
            width: 100% !important; 
            margin-bottom: 6px;
            height: 36px !important;
            border-radius: 10px !important;
            font-size: 12px !important;
        }
    }

    /* 공통 스타일 유지 */
    .date-text {
        font-size: 11px;
        font-weight: 900;
        background: rgba(15, 23, 42, 0.6); 
        padding: 2px 6px;
        border-radius: 6px;
        display: inline-block;
        min-width: 22px;
        text-align: center;
    }
    .date-text.is-today {
        background: #a855f7 !important;
        color: white !important;
        border-radius: 999px;
        box-shadow: 0 0 12px rgba(168, 85, 247, 0.4);
    }
    .sch-item {
        position: absolute;
        z-index: 10;
        font-size: 10px; 
        font-weight: 800; 
        padding: 0 8px; 
        height: 22px;
        line-height: 22px;
        border-radius: 4px;
        cursor: pointer; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
        transition: all 0.2s; 
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .sch-item:hover { filter: brightness(1.1); z-index: 50; transform: scale(1.01); }
    .sch-staff-tag { font-size: 9px; opacity: 0.7; background: rgba(0,0,0,0.3); padding: 0 5px; border-radius: 4px; }
    
    /* 타임라인 연결 스타일 (데스크톱 전용) */
    @media (min-width: 768px) {
        .sch-item.continued-from-prev { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: none; }
        .sch-item.continues-to-next { border-top-right-radius: 0; border-bottom-right-radius: 0; }
    }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
(function() {
    let viewDate = new Date();
    const db = firebase.database();
    let startPicker, endPicker, editStartPicker, editEndPicker;
    const todayStr = new Date().toLocaleDateString('sv-SE');

    // 시간 선택기 초기화 (신규 등록용)
    function initTimePickers(isAllDay = false) {
        const config = {
            enableTime: !isAllDay,
            dateFormat: isAllDay ? "Y-m-d" : "Y-m-d H:i",
            altInput: true,
            altFormat: isAllDay ? "Y-m-d" : "Y-m-d h:i K",
            static: true,
            locale: "en"
        };
        if (startPicker) startPicker.destroy();
        if (endPicker) endPicker.destroy();
        startPicker = flatpickr("#new_sch_start", config);
        endPicker = flatpickr("#new_sch_end", config);
    }

    // 시간 선택기 초기화 (수정용)
    function initEditTimePickers(isAllDay = false) {
        const config = {
            enableTime: !isAllDay,
            dateFormat: isAllDay ? "Y-m-d" : "Y-m-d H:i",
            altInput: true,
            altFormat: isAllDay ? "Y-m-d" : "Y-m-d h:i K",
            static: true,
            locale: "en"
        };
        if (editStartPicker) editStartPicker.destroy();
        if (editEndPicker) editEndPicker.destroy();
        editStartPicker = flatpickr("#edit_sch_start", config);
        editEndPicker = flatpickr("#edit_sch_end", config);
    }

    window.toggleAdminTimePicker = function(isAllDay) { initTimePickers(isAllDay); };
    window.toggleEditTimePicker = function(isAllDay) { initEditTimePickers(isAllDay); };

    // 1. 신규 일정 추가 팝업
    window.addAdminSchedule = function(dateStr) {
        const titleHtml = `<div class="text-lg font-black text-white tracking-tighter uppercase">Schedule Entry</div>`;
        const bodyHtml = `
            <div class="space-y-4 pt-2 text-left">
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 font-black uppercase ml-1">Title</label>
                    <input type="text" id="new_sch_title" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm text-white focus:border-purple-500 outline-none transition-all">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] text-slate-500 font-black uppercase ml-1">Start</label>
                        <input type="text" id="new_sch_start" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-xs text-white">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] text-slate-500 font-black uppercase ml-1">End</label>
                        <input type="text" id="new_sch_end" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-xs text-white">
                    </div>
                </div>
                <div class="flex items-center gap-2 ml-1">
                    <input type="checkbox" id="new_sch_allday" onchange="window.toggleAdminTimePicker(this.checked)" class="w-4 h-4 rounded border-slate-700 bg-slate-950">
                    <label for="new_sch_allday" class="text-xs text-slate-400 font-bold cursor-pointer">All Day Event</label>
                </div>
                <textarea id="new_sch_desc" placeholder="Description..." class="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-sm text-slate-300 h-24 resize-none outline-none focus:border-purple-500"></textarea>
                <div class="bg-purple-500/5 border border-purple-500/10 rounded-xl p-3">
                    <label class="text-[9px] text-purple-400 font-black uppercase tracking-widest mb-1 block">Private Admin Memo</label>
                    <textarea id="new_admin_memo" class="w-full bg-transparent text-sm text-purple-200 h-16 resize-none outline-none" placeholder="Internal notes..."></textarea>
                </div>
                <button onclick="window.saveNewAdminSchedule()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-black py-4 rounded-2xl transition-all shadow-lg shadow-purple-900/20 text-sm tracking-widest uppercase active:scale-95">Save Schedule</button>
            </div>`;

        if (window.openAdminCustomModal) {
            window.openAdminCustomModal(titleHtml, bodyHtml);
            setTimeout(() => {
                initTimePickers(false);
                startPicker.setDate(dateStr + " 09:00");
                endPicker.setDate(dateStr + " 10:00");
            }, 50);
        }
    };

    window.saveNewAdminSchedule = function() {
        const title = document.getElementById('new_sch_title').value;
        const start = document.getElementById('new_sch_start').value;
        const end = document.getElementById('new_sch_end').value;
        if(!title || !start) return alert('Title and Start Date are required.');

        db.ref('shared_schedules').push({
            title, 
            start: start.replace(' ', 'T'), 
            end: end ? end.replace(' ', 'T') : start.replace(' ', 'T'),
            allDay: document.getElementById('new_sch_allday').checked,
            desc: document.getElementById('new_sch_desc').value,
            adminMemo: document.getElementById('new_admin_memo').value,
            author: 'admin',
            timestamp: Date.now()
        }).then(() => { if(window.closeAdminCustomModal) window.closeAdminCustomModal(); });
    };

    // 2. 일정 상세 및 수정 팝업 (수정됨)
    window.showAdminSchDetail = function(id, title, start, end, author, desc, adminMemo) {
        const decodedDesc = decodeURIComponent(desc || '');
        const decodedMemo = decodeURIComponent(adminMemo || '');
        const isAllDay = !start.includes(':') || !end.includes(':');
        
        const titleHtml = `<div class="text-lg font-black text-white tracking-tighter uppercase">Edit Schedule</div>`;
        const bodyHtml = `
            <div class="space-y-4 pt-2 text-left">
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 font-black uppercase ml-1">Title</label>
                    <input type="text" id="edit_sch_title" value="${title}" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm text-white focus:border-purple-500 outline-none transition-all">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] text-slate-500 font-black uppercase ml-1">Start</label>
                        <input type="text" id="edit_sch_start" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-xs text-white">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] text-slate-500 font-black uppercase ml-1">End</label>
                        <input type="text" id="edit_sch_end" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-xs text-white">
                    </div>
                </div>

                <div class="flex items-center gap-2 ml-1">
                    <input type="checkbox" id="edit_sch_allday" ${isAllDay ? 'checked' : ''} onchange="window.toggleEditTimePicker(this.checked)" class="w-4 h-4 rounded border-slate-700 bg-slate-950">
                    <label for="edit_sch_allday" class="text-xs text-slate-400 font-bold cursor-pointer">All Day Event</label>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 font-black uppercase ml-1">Description</label>
                    <textarea id="edit_sch_desc" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-sm text-slate-300 h-24 resize-none outline-none focus:border-purple-500">${decodedDesc}</textarea>
                </div>

                <div class="bg-purple-500/5 border border-purple-500/10 rounded-xl p-3">
                    <label class="text-[9px] text-purple-400 font-black uppercase tracking-widest mb-1 block">Private Admin Memo</label>
                    <textarea id="edit_admin_memo" class="w-full bg-transparent text-sm text-purple-200 h-16 resize-none outline-none" placeholder="Internal notes...">${decodedMemo}</textarea>
                </div>

                <div class="flex gap-2">
                    <button onclick="window.updateAdminSchedule('${id}')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition-all text-sm uppercase active:scale-95">Update</button>
                    <button onclick="window.deleteAdminSchedule('${id}')" class="px-6 bg-slate-800 hover:bg-rose-600 text-slate-400 hover:text-white font-black py-4 rounded-2xl transition-all text-sm uppercase active:scale-95">Delete</button>
                </div>
            </div>`;

        if (window.openAdminCustomModal) {
            window.openAdminCustomModal(titleHtml, bodyHtml);
            setTimeout(() => {
                initEditTimePickers(isAllDay);
                editStartPicker.setDate(start.replace('T', ' '));
                editEndPicker.setDate(end.replace('T', ' '));
            }, 50);
        }
    };

    // 3. 일정 업데이트 함수 (신규 추가)
    window.updateAdminSchedule = function(id) {
        const title = document.getElementById('edit_sch_title').value;
        const start = document.getElementById('edit_sch_start').value;
        const end = document.getElementById('edit_sch_end').value;
        if(!title || !start) return alert('Title and Start Date are required.');

        db.ref('shared_schedules').child(id).update({
            title,
            start: start.replace(' ', 'T'),
            end: end ? end.replace(' ', 'T') : start.replace(' ', 'T'),
            allDay: document.getElementById('edit_sch_allday').checked,
            desc: document.getElementById('edit_sch_desc').value,
            adminMemo: document.getElementById('edit_admin_memo').value,
            lastModified: Date.now()
        }).then(() => { if(window.closeAdminCustomModal) window.closeAdminCustomModal(); });
    };

    window.deleteAdminSchedule = function(id) {
        if(!confirm('Are you sure you want to delete this schedule?')) return;
        db.ref('shared_schedules').child(id).remove()
            .then(() => { if(window.closeAdminCustomModal) window.closeAdminCustomModal(); })
            .catch(err => alert('Error: ' + err.message));
    };

    // 렌더링 로직 (기존과 동일)
window.renderScheduleFull = function() {
    const year = viewDate.getFullYear(), month = viewDate.getMonth();
    const isMobile = window.innerWidth < 768;
    
    // [추가] 요소 존재 여부 확인 (에러 방지 핵심 코드)
    const monthEl = document.getElementById('full_sch_month');
    const tbody = document.getElementById('full_sch_calendar_body');
    
    // 화면에 렌더링할 준비가 안 되었다면 함수 종료
    if (!monthEl || !tbody) {
        console.warn("Schedule components not yet loaded in DOM.");
        return;
    }

    // 날짜 텍스트 업데이트
    monthEl.innerText = viewDate.toLocaleString('en-US', {month:'short', year:'numeric'});

    db.ref('shared_schedules').off();
    db.ref('shared_schedules').on('value', snap => {
        const data = snap.val() || {};
        
        // [추가] Firebase 응답 시점에 요소가 사라졌을 경우를 대비한 2차 확인
        const currentTbody = document.getElementById('full_sch_calendar_body');
        if (!currentTbody) return;

        currentTbody.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        
        const sortedEvents = Object.entries(data).map(([id, ev]) => ({
            id, ...ev,
            sDate: ev.start.split('T')[0],
            eDate: ev.end.split('T')[0]
        })).sort((a, b) => (new Date(b.eDate) - new Date(b.sDate)) - (new Date(a.eDate) - new Date(a.sDate)) || a.sDate.localeCompare(b.sDate));

        const eventFinalSlot = {};
        const daySlotUsage = {};
        sortedEvents.forEach(ev => {
            let slot = 0;
            while (true) {
                let isAvailable = true;
                for (let d = new Date(ev.sDate); d <= new Date(ev.eDate); d.setDate(d.getDate() + 1)) {
                    const dStr = d.toISOString().split('T')[0];
                    if (daySlotUsage[dStr] && daySlotUsage[dStr].has(slot)) { isAvailable = false; break; }
                }
                if (isAvailable) {
                    for (let d = new Date(ev.sDate); d <= new Date(ev.eDate); d.setDate(d.getDate() + 1)) {
                        const dStr = d.toISOString().split('T')[0];
                        if (!daySlotUsage[dStr]) daySlotUsage[dStr] = new Set();
                        daySlotUsage[dStr].add(slot);
                    }
                    eventFinalSlot[ev.id] = slot;
                    break;
                }
                slot++;
            }
        });

        let dateNum = 1;
        for (let i = 0; i < 6; i++) {
            const tr = document.createElement('tr');
            let hasDateInRow = false;
            let maxSlotsInWeek = 0;

            for (let j = 0; j < 7; j++) {
                const td = document.createElement('td');
                if ((i === 0 && j < firstDay) || dateNum > lastDate) {
                    if (!isMobile) tr.appendChild(td);
                    continue;
                }
                
                hasDateInRow = true;
                const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dateNum).padStart(2,'0')}`;
                const isToday = (dStr === todayStr);

                if (daySlotUsage[dStr]) {
                    const dayMaxSlot = Math.max(...Array.from(daySlotUsage[dStr]), -1) + 1;
                    if (dayMaxSlot > maxSlotsInWeek) maxSlotsInWeek = dayMaxSlot;
                }

                td.onclick = (e) => { if(e.target.tagName === 'TD' || e.target.classList.contains('date-wrapper')) window.addAdminSchedule(dStr); };

                let html = `<div class="date-wrapper flex justify-between items-center">
                    <span class="date-text ${isToday ? 'is-today' : ''} ${j===0?'text-rose-500':(j===6?'text-blue-500':'text-slate-400')}">
                        ${dateNum}
                    </span>
                    ${isMobile && isToday ? '<span class="text-[9px] font-black text-purple-400 uppercase tracking-widest">Today</span>' : ''}
                </div>`;
                
                sortedEvents.filter(ev => dStr >= ev.sDate && dStr <= ev.eDate).forEach(ev => {
                    const shouldShow = isMobile || (dStr === ev.sDate || j === 0);
                    if (shouldShow) {
                        const currentSlot = eventFinalSlot[ev.id];
                        const diffDays = Math.ceil((new Date(ev.eDate) - new Date(dStr)) / 86400000);
                        const span = Math.min(diffDays + 1, 7 - j);
                        const isContinued = !isMobile && dStr > ev.sDate ? 'continued-from-prev' : '';
                        
                        html += `<div onclick="event.stopPropagation(); window.showAdminSchDetail('${ev.id}', '${ev.title.replace(/'/g, "\\'")}', '${ev.start}', '${ev.end}', '${ev.author}', '${encodeURIComponent(ev.desc||'')}', '${encodeURIComponent(ev.adminMemo||'')}')" 
                            class="sch-item ${ev.adminMemo?'bg-purple-600':'bg-blue-600'} ${isContinued} text-white" 
                            style="${isMobile ? '' : `top: ${36 + (currentSlot * 26)}px; width: calc(${span * 100}% - 12px);`}">
                            <span class="sch-title-text">${(isContinued && !isMobile) ? '' : ev.title}</span>
                            <span class="sch-staff-tag">${ev.author||''}</span>
                        </div>`;
                    }
                });

                td.innerHTML = html;
                tr.appendChild(td);
                dateNum++;
            }

            if (hasDateInRow) {
                if (!isMobile) {
                    const calculatedHeight = 40 + (maxSlotsInWeek * 26) + 20; 
                    tr.style.height = Math.max(140, calculatedHeight) + 'px';
                }
                currentTbody.appendChild(tr);
            }
            if (dateNum > lastDate) break;
        }
    });
};


    window.changeSchMonth = (offset) => { viewDate.setMonth(viewDate.getMonth() + offset); window.renderScheduleFull(); };
    window.goTodaySch = () => { viewDate = new Date(); window.renderScheduleFull(); };

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(window.renderScheduleFull, 250);
    });

    window.renderScheduleFull();
})();
</script>