<div class="animate-fadeIn space-y-6">
    <div class="bg-slate-900/50 p-4 md:p-6 rounded-[32px] border border-slate-800 shadow-2xl backdrop-blur-sm">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-8 gap-4">
            <h2 class="text-xl md:text-2xl font-black text-white flex items-center gap-3">
                <div class="w-1.5 h-7 md:w-2 md:h-8 bg-emerald-500 rounded-full"></div>
                WORK REPORTS <span class="text-emerald-500/50 font-light text-sm md:text-lg uppercase tracking-widest hidden sm:inline">Calendar</span>
            </h2>
            
            <div class="flex items-center gap-3 bg-slate-800/50 p-1.5 rounded-2xl border border-slate-700/50">
                <button onclick="window.goWorkToday()" class="px-3 py-1.5 bg-slate-700 hover:bg-emerald-600 text-white text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter">
                    Today
                </button>
                <div class="w-[1px] h-4 bg-slate-700 mx-1"></div>

                <button onclick="window.changeWorkMonth(-1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div id="full_work_month" class="text-xs md:text-sm font-black text-white px-2 min-w-[120px] md:min-w-[140px] text-center tracking-tighter italic uppercase"></div>
                <button onclick="window.changeWorkMonth(1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <div class="overflow-x-visible md:overflow-x-auto rounded-2xl md:border md:border-slate-800 shadow-inner bg-transparent md:bg-slate-950/20">
            <table class="w-full table-fixed border-collapse">
                <thead>
                    <tr class="hidden md:table-row text-slate-500 text-[11px] font-black uppercase tracking-widest bg-slate-800/30">
                        <th class="py-4 border-b border-slate-800 text-red-400/80">Sun</th>
                        <th class="py-4 border-b border-slate-800">Mon</th>
                        <th class="py-4 border-b border-slate-800">Tue</th>
                        <th class="py-4 border-b border-slate-800">Wed</th>
                        <th class="py-4 border-b border-slate-800">Thu</th>
                        <th class="py-4 border-b border-slate-800">Fri</th>
                        <th class="py-4 border-b border-slate-800 text-blue-400/80">Sat</th>
                    </tr>
                </thead>
                <tbody id="full_work_calendar_body" class="flex flex-col gap-4 md:table-row-group">
                    </tbody>
            </table>
        </div>

        <div class="mt-8 pt-6 border-t border-slate-800 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="text-center sm:text-left">
                <h3 class="text-white font-black text-sm uppercase tracking-widest mb-1">Export Work Reports</h3>
                <p class="text-slate-500 text-[10px]">PDF files are grouped by staff and period.</p>
            </div>
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="window.exportWorkPDF('monthly')" class="px-4 py-2.5 bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white border border-blue-600/30 rounded-xl text-[11px] font-black transition-all uppercase tracking-widest">
                    Monthly PDF
                </button>
                <button onclick="window.exportWorkPDF('yearly')" class="px-4 py-2.5 bg-purple-600/20 hover:bg-purple-600 text-purple-400 hover:text-white border border-purple-600/30 rounded-xl text-[11px] font-black transition-all uppercase tracking-widest">
                    Yearly PDF
                </button>
                <button onclick="window.exportWorkPDF('overall')" class="px-4 py-2.5 bg-emerald-600/20 hover:bg-emerald-600 text-emerald-400 hover:text-white border border-emerald-600/30 rounded-xl text-[11px] font-black transition-all uppercase tracking-widest">
                    Overall PDF
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Îç∞Ïä§ÌÅ¨ÌÜ± Ï†ÑÏö© Ïä§ÌÉÄÏùº */
    @media (min-width: 768px) {
        #full_work_calendar_body { display: table-row-group; }
        #full_work_calendar_body tr { display: table-row; }
        #full_work_calendar_body td { 
            height: 140px; 
            border: 1px solid rgba(30, 41, 59, 0.5); 
            vertical-align: top; 
            padding: 10px;
            transition: background-color 0.2s;
        }
        #full_work_calendar_body td:hover { background-color: rgba(30, 41, 59, 0.3); }
    }

    /* Î™®Î∞îÏùº Ï†ÑÏö© Ïä§ÌÉÄÏùº (768px ÎØ∏Îßå) */
    @media (max-width: 767px) {
        #full_work_calendar_body td {
            display: block;
            width: 100% !important;
            height: auto !important;
            padding: 0;
            border: none !important;
        }
        /* ÎÇ†ÏßúÍ∞Ä ÏóÜÎäî Îπà Ïπ∏ Ïà®Í∏∞Í∏∞ */
        #full_work_calendar_body td:empty { display: none; }
        
        .mobile-day-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 8px;
        }
        .mobile-day-card.today-active {
            border: 1px solid #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
    }

    /* Î¶¨Ìè¨Ìä∏ ÏïÑÏù¥ÌÖú Ïä§ÌÉÄÏùº Í≥µÌÜµ */
    .work-item {
        font-size: 11px;
        font-weight: 800;
        padding: 6px 10px;
        border-radius: 10px;
        margin-bottom: 4px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    @media (max-width: 767px) {
        .work-item { font-size: 13px; padding: 12px; margin-bottom: 8px; }
    }
    .work-item:hover { 
        filter: brightness(1.2); 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .work-item:active { transform: scale(0.96); }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    (function() {
        let viewDate = new Date();
        const db = firebase.database();

        // [Ï∂îÍ∞Ä] Ïò§Îäò ÎÇ†Ïßú Ïù¥Îèô Ìï®Ïàò
        window.goWorkToday = function() {
            viewDate = new Date();
            window.renderWorkFull();
        };

        // [Ï∂îÍ∞Ä] PDF ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÌïµÏã¨ Î°úÏßÅ
    window.exportWorkPDF = async function(type) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    try {
        const snap = await db.ref('reports').once('value');
        const data = snap.val() || {};
        
        const year = viewDate.getFullYear();
        const month = String(viewDate.getMonth() + 1).padStart(2, '0');
        
        let filteredData = {};
        
        Object.entries(data).forEach(([dateStr, staffObj]) => {
            const [dYear, dMonth] = dateStr.split('-');
            let isMatch = false;
            
            if (type === 'monthly' && dYear == year && dMonth == month) isMatch = true;
            else if (type === 'yearly' && dYear == year) isMatch = true;
            else if (type === 'overall') isMatch = true;
            
            if (isMatch) {
                Object.entries(staffObj).forEach(([staffName, report]) => {
                    if (!filteredData[staffName]) filteredData[staffName] = [];
                    
                    // [ÏàòÏ†ï] ÏÉÅÌÉúÍ∞í ÏòÅÏñ¥ Î≥ÄÌôò Îß§Ìïë
                    let englishStatus = report.status;
                    if(report.status === 'ÏôÑÎ£å' || report.status === 'Completed') englishStatus = 'COMPLETED';
                    else if(report.status === 'ÏßÑÌñâÏ§ë' || report.status === 'In Progress') englishStatus = 'IN PROGRESS';
                    else if(report.status === 'ÎåÄÍ∏∞' || report.status === 'Pending') englishStatus = 'PENDING';

                    filteredData[staffName].push({
                        date: dateStr,
                        status: englishStatus,
                        content: report.content, // ÎÇ¥Ïö©ÏùÄ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú Í≤ÉÏù¥Îùº ÏòÅÏñ¥Í∞Ä ÏïÑÎãê Ïàò ÏûàÏùå
                        memo: report.adminMemo || '-'
                    });
                });
            }
        });

        const staffNames = Object.keys(filteredData).sort();
        if (staffNames.length === 0) return alert("No data found.");

        staffNames.forEach((staff, index) => {
            if (index > 0) doc.addPage();
            
            doc.setFontSize(18);
            doc.text(`WORK REPORT: ${staff}`, 14, 20);
            doc.setFontSize(10);
            
            // [ÏàòÏ†ï] ÎÇ†Ïßú Ìè¨Îß∑ Î∞è Ìó§Îçî ÏòÅÏñ¥Î°ú Î≥ÄÍ≤Ω
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
            doc.text(`Export Type: ${type.toUpperCase()} | Generated: ${timestamp}`, 14, 28);

            const rows = filteredData[staff]
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(item => [item.date, item.status, item.content, item.memo]);

            doc.autoTable({
                startY: 35,
                head: [['Date', 'Status', 'Content', 'Admin Memo']], // Ìó§Îçî ÏòÅÏñ¥
                body: rows,
                theme: 'grid',
                headStyles: { fillColor: [30, 41, 59] },
                styles: { fontSize: 8, font: 'helvetica' } // ÏòÅÏñ¥ Ï†ÑÏö© Ìè∞Ìä∏ ÏÑ§Ï†ï
            });
        });

        doc.save(`Report_${type}_${year}_${month}.pdf`);
    } catch (err) {
        console.error(err);
        alert("Export failed.");
    }
};


        // ÌÜµÌï© Ï†ÄÏû• Ìï®Ïàò
        window.updateAdminReport = function(date, name) {
            const newContent = document.getElementById('editContentInput').value;
            const newStatus = document.getElementById('editStatusSelect').value;
            const newMemo = document.getElementById('adminMemoInput').value;

            if(!confirm(`${name}ÎãòÏùò Î¶¨Ìè¨Ìä∏ ÎÇ¥Ïö©ÏùÑ ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            db.ref(`reports/${date}/${name}`).update({
                content: newContent,
                status: newStatus,
                adminMemo: newMemo,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                if(window.closeAdminCustomModal) window.closeAdminCustomModal();
            }).catch(err => {
                alert('Update failed.');
            });
        };

        // Î¶¨Ìè¨Ìä∏ ÏÇ≠Ï†ú Ìï®Ïàò
        window.deleteAdminReport = function(date, name) {
            if(!confirm(`‚ö†Ô∏è Í≤ΩÍ≥†: ${name}ÎãòÏùò Î¶¨Ìè¨Ìä∏Î•º ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            db.ref(`reports/${date}/${name}`).remove()
                .then(() => {
                    if(window.closeAdminCustomModal) window.closeAdminCustomModal();
                })
                .catch(err => {
                    alert('Delete failed.');
                });
        };

        // ÏÉÅÏÑ∏ ÌåùÏóÖÏ∞Ω (Î∞òÏùëÌòï ÏµúÏ†ÅÌôî)
        window.showWorkDetail = function(name, date, status, contentEncoded, memoEncoded) {
            const content = decodeURIComponent(contentEncoded);
            const memo = decodeURIComponent(memoEncoded || '');
            
            const titleHtml = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center text-slate-900 font-black shadow-lg">
                        ${name.charAt(0)}
                    </div>
                    <div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest leading-none mb-1">${date}</div>
                        <div class="text-lg font-black text-white leading-none">${name}'s Report</div>
                    </div>
                </div>`;

            const bodyHtml = `
                <div class="space-y-5 animate-fadeIn pb-2">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-3">
                        <div class="w-full sm:flex-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1.5 block ml-1">Current Status</label>
                            <select id="editStatusSelect" class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-emerald-500 appearance-none">
                                <option value="In Progress" ${status === 'In Progress' ? 'selected' : ''}>üîµ IN PROGRESS</option>
                                <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>üü° PENDING</option>
                                <option value="Completed" ${status === 'Completed' ? 'selected' : ''}>üü¢ COMPLETED</option>
                            </select>
                        </div>
                        <button onclick="window.deleteAdminReport('${date}', '${name}')" 
                            class="w-full sm:w-auto bg-rose-900/20 hover:bg-rose-600 text-rose-500 hover:text-white px-5 py-3 rounded-xl border border-rose-900/50 transition-all text-[10px] font-black uppercase tracking-tighter">
                            Delete
                        </button>
                    </div>

                    <div class="relative">
                        <div class="absolute -top-2.5 left-4 bg-slate-900 px-2 text-[9px] font-black text-emerald-500 tracking-widest uppercase z-10">Report Content</div>
                        <textarea id="editContentInput" 
                            class="w-full bg-slate-950 border border-slate-700 rounded-2xl p-4 text-sm text-slate-300 leading-relaxed min-h-[140px] outline-none focus:border-emerald-500 shadow-inner resize-none">${content}</textarea>
                    </div>

                    <div class="relative">
                        <div class="absolute -top-2.5 left-4 bg-slate-900 px-2 text-[9px] font-black text-blue-400 tracking-widest uppercase z-10">Admin Memo</div>
                        <textarea id="adminMemoInput" 
                            class="w-full bg-slate-950/40 border border-slate-700/50 rounded-2xl p-4 text-sm text-white outline-none focus:border-blue-500 min-h-[80px] resize-none" 
                            placeholder="Add private manager notes...">${memo}</textarea>
                    </div>

                    <button onclick="window.updateAdminReport('${date}', '${name}')" 
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black text-sm py-4 rounded-2xl transition-all uppercase tracking-widest shadow-xl active:scale-95">
                        Save Changes
                    </button>
                </div>`;

            if (typeof window.openAdminCustomModal === 'function') {
                window.openAdminCustomModal(titleHtml, bodyHtml);
            }
        };

        window.renderWorkFull = function() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const isMobile = window.innerWidth < 768;
            
            document.getElementById('full_work_month').innerText = viewDate.toLocaleString('en-US', {month:'long', year:'numeric'});

            db.ref('reports').off();
            db.ref('reports').on('value', snap => {
                const data = snap.val() || {};
                const tbody = document.getElementById('full_work_calendar_body');
                tbody.innerHTML = '';

                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const todayStr = new Date().toLocaleDateString('sv-SE');
                
                let dateNum = 1;
                for (let i = 0; i < 6; i++) {
                    let tr = document.createElement('tr');
                    let hasCellsInRow = false;

                    for (let j = 0; j < 7; j++) {
                        let td = document.createElement('td');
                        if (i === 0 && j < firstDay || dateNum > lastDate) {
                            if (!isMobile) tr.appendChild(td);
                        } else {
                            hasCellsInRow = true;
                            const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dateNum).padStart(2, '0')}`;
                            const isToday = todayStr === dStr;
                            
                            // ÎÇ†Ïßú Ìó§Îçî ÎîîÏûêÏù∏
                            let dayHeader = `
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-[11px] font-black ${isToday ? 'bg-emerald-500 text-slate-900 w-6 h-6 flex items-center justify-center rounded-lg shadow-lg shadow-emerald-500/20' : (j === 0 ? 'text-rose-500' : (j === 6 ? 'text-blue-400' : 'text-slate-500'))}">${dateNum}</span>
                                    ${isToday && isMobile ? '<span class="text-[9px] font-black text-emerald-500 uppercase tracking-widest">Today</span>' : ''}
                                </div>`;
                            
                            const dayReports = data[dStr] || {};
                            let reportHtml = '<div class="space-y-1.5">';
                            
                            const reportEntries = Object.entries(dayReports);
                            if (reportEntries.length > 0) {
                                reportEntries.forEach(([name, report]) => {
                                    const statusColor = report.status === 'Completed' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 
                                                      (report.status === 'Pending' ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : 'bg-blue-500/10 text-blue-400 border-blue-500/20');
                                    
                                    const safeContent = encodeURIComponent(report.content || '');
                                    const safeMemo = encodeURIComponent(report.adminMemo || '');
                                    
                                    reportHtml += `
                                        <div onclick="window.showWorkDetail('${name}', '${dStr}', '${report.status}', '${safeContent}', '${safeMemo}')" 
                                             class="work-item border ${statusColor}">
                                            <span class="w-1.5 h-1.5 rounded-full bg-current opacity-60"></span>
                                            ${name}
                                        </div>`;
                                });
                            } else if(isMobile) {
                                reportHtml += `<div class="text-[10px] text-slate-700 italic py-1">No reports today</div>`;
                            }
                            reportHtml += '</div>';
                            
                            if (isMobile) {
                                td.className = `mobile-day-card ${isToday ? 'today-active' : ''}`;
                                td.innerHTML = dayHeader + reportHtml;
                            } else {
                                td.innerHTML = dayHeader + reportHtml;
                            }

                            tr.appendChild(td);
                            dateNum++;
                        }
                    }
                    if (hasCellsInRow) tbody.appendChild(tr);
                    if (dateNum > lastDate) break;
                }
            });
        };

        window.changeWorkMonth = (offset) => {
            viewDate.setMonth(viewDate.getMonth() + offset);
            window.renderWorkFull();
        };

        // Î∞òÏùëÌòï ÎåÄÏùë Î¶¨Î†åÎçîÎßÅ
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(window.renderWorkFull, 250);
        });

        window.renderWorkFull();
    })();
</script>