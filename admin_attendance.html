<div class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-white flex items-center gap-2">
            <span class="text-blue-500">‚ñ†</span> STAFF ATTENDANCE (FULL)
        </h2>
        <div id="full_att_month" class="text-lg font-bold text-blue-400 italic uppercase"></div>
        <div class="flex bg-slate-800 rounded-lg p-1">
            <button onclick="changeFullMonth(-1)" class="px-3 py-1 text-slate-400 text-xs font-black">PREV</button>
            <button onclick="goTodayFull()" class="px-3 py-1 text-blue-400 text-xs font-black mx-1">TODAY</button>
            <button onclick="changeFullMonth(1)" class="px-3 py-1 text-slate-400 text-xs font-black">NEXT</button>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="calendar-table w-full min-w-[800px] table-fixed">
            <thead>
                <tr class="text-slate-500 text-[10px] uppercase">
                    <th class="py-2">Sun</th><th class="py-2">Mon</th><th class="py-2">Tue</th>
                    <th class="py-2">Wed</th><th class="py-2">Thu</th><th class="py-2">Fri</th><th class="py-2">Sat</th>
                </tr>
            </thead>
            <tbody id="full_att_calendar_body"></tbody>
        </table>
    </div>
</div>

<script>
    (function() {
        const db = firebase.database();
        let viewDate = new Date();

        // --- [Ï∂îÍ∞Ä] Ï∂úÌá¥Í∑º ÏàòÏ†ï Î™®Îã¨ Ïò§Ìîà Ìï®Ïàò ---
        window.openEditAttendance = function(name, date, infoEncoded) {
            const info = JSON.parse(decodeURIComponent(infoEncoded));
            const isSpecial = typeof info === 'string';
            
            const currentAttend = isSpecial ? "" : (info.attend || "");
            const currentLeave = isSpecial ? "" : (info.leave || "");
            const currentSpecial = isSpecial ? info : "";

            const titleHtml = `
                <div class="flex flex-col">
                    <span class="text-[10px] text-blue-500 font-black uppercase tracking-widest">Edit Attendance</span>
                    <span class="text-lg font-black text-white">${name} <span class="text-slate-500 text-sm">(${date})</span></span>
                </div>`;

            const bodyHtml = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Standard Status</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="editAttend" placeholder="ATT(8:00)" value="${currentAttend}" 
                                   class="bg-slate-800 text-white text-xs p-3 rounded-xl border border-slate-700 outline-none focus:border-emerald-500">
                            <input type="text" id="editLeave" placeholder="17:00:00" value="${currentLeave}" 
                                   class="bg-slate-800 text-white text-xs p-3 rounded-xl border border-slate-700 outline-none focus:border-blue-500">
                        </div>
                    </div>
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-800"></span></div>
                        <div class="relative flex justify-center text-[10px] uppercase font-bold text-slate-600"><span class="bg-slate-900 px-2">OR Special Status</span></div>
                    </div>
                    <div>
                        <select id="editSpecial" class="w-full bg-slate-800 text-white text-xs p-3 rounded-xl border border-slate-700 outline-none focus:border-amber-500 cursor-pointer">
                            <option value="" ${currentSpecial === "" ? "selected" : ""}>--- NO SPECIAL STATUS ---</option>
                            <option value="WO" ${currentSpecial === "WO" ? "selected" : ""}>WO (Work Out)</option>
                            <option value="PEL" ${currentSpecial === "PEL" ? "selected" : ""}>PEL (Personal Leave)</option>
                            <option value="ANL" ${currentSpecial === "ANL" ? "selected" : ""}>ANL (Annual Leave)</option>
                            <option value="SIL" ${currentSpecial === "SIL" ? "selected" : ""}>SIL (Sick Leave)</option>
                            <option value="OFF" ${currentSpecial === "OFF" ? "selected" : ""}>OFF (Day Off)</option>
                        </select>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="window.saveAttendanceEdit('${name}', '${date}')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded-xl text-xs transition-all active:scale-95">SAVE CHANGES</button>
                        <button onclick="window.deleteAttendance('${name}', '${date}')" class="bg-rose-600/20 text-rose-500 font-black px-4 rounded-xl text-[10px] hover:bg-rose-600 hover:text-white transition-all">DELETE</button>
                    </div>
                </div>`;

            if(window.openAdminCustomModal) {
                window.openAdminCustomModal(titleHtml, bodyHtml);
            } else {
                alert("Modal function not found.");
            }
        };

        // --- [Ï∂îÍ∞Ä] Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ìï®Ïàò ---
        window.saveAttendanceEdit = function(name, date) {
            const attend = document.getElementById('editAttend').value.trim();
            const leave = document.getElementById('editLeave').value.trim();
            const special = document.getElementById('editSpecial').value;

            let updateData = special ? special : { attend: attend, leave: leave };

            if(confirm(`Update record for ${name} on ${date}?`)) {
                db.ref(`attendance/${date}/${name}`).set(updateData)
                .then(() => {
                    if(window.closeAdminCustomModal) window.closeAdminCustomModal();
                });
            }
        };

        // --- [Ï∂îÍ∞Ä] Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ìï®Ïàò ---
        window.deleteAttendance = function(name, date) {
            if(confirm(`Delete ${name}'s record for ${date}?`)) {
                db.ref(`attendance/${date}/${name}`).remove()
                .then(() => {
                    if(window.closeAdminCustomModal) window.closeAdminCustomModal();
                });
            }
        };

        window.renderAttendanceFull = function() {
            document.getElementById('full_att_month').innerText = viewDate.toLocaleString('en-US', {month:'long', year:'numeric'});
            db.ref('attendance').on('value', snap => {
                const data = snap.val() || {};
                const tbody = document.getElementById('full_att_calendar_body');
                tbody.innerHTML = '';
                
                const year = viewDate.getFullYear(), month = viewDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const todayStr = new Date().toISOString().split('T')[0];
                let dateNum = 1;

                for (let i = 0; i < 6; i++) {
                    let row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        let cell = document.createElement('td');
                        cell.className = "border border-slate-800 h-28 p-2 vertical-top align-top";
                        if (i === 0 && j < firstDay || dateNum > lastDate) { 
                            row.appendChild(cell); 
                        } else {
                            const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dateNum).padStart(2,'0')}`;
                            if(dStr === todayStr) cell.classList.add('today-highlight');
                            
                            let content = `<div class="text-[10px] font-bold mb-1 opacity-50">${dateNum}</div>`;
                            
                            Object.entries(data[dStr] || {}).forEach(([name, info]) => {
                                let attHtml = '';
                                const safeInfo = encodeURIComponent(JSON.stringify(info));

                                if (typeof info === 'string') {
                                    attHtml = `<span class="text-amber-500 font-bold">${info}</span>`;
                                } else {
                                    const attend = info.attend || "";
                                    const leave = info.leave || "";
                                    const sClass = attend.includes("LATE") ? "text-rose-500" : (attend.includes("ATT") ? "text-emerald-500" : "text-slate-500");
                                    
                                    attHtml = `
                                        <div class="flex flex-col items-end">
                                            <span class="${sClass} font-bold text-right">‚òÄÔ∏è ${attend}</span>
                                            ${leave ? `<span class="text-slate-400 font-bold text-right">üåô ${leave}</span>` : ''}
                                        </div>`;
                                }

                                // [ÏàòÏ†ïÎê®] onclick Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä Î∞è Ïª§ÏÑú Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
                                content += `
                                    <div onclick="window.openEditAttendance('${name}', '${dStr}', '${safeInfo}')" 
                                         class="flex justify-between items-start text-[9px] mb-1 bg-slate-800/40 p-1.5 rounded border border-slate-700/30 gap-1 cursor-pointer hover:bg-slate-700 transition-all active:scale-95">
                                        <span class="truncate w-10 text-slate-300 font-bold">${name}</span>
                                        ${attHtml}
                                    </div>`;
                            });

                            cell.innerHTML = content;
                            row.appendChild(cell);
                            dateNum++;
                        }
                    }
                    tbody.appendChild(row);
                    if (dateNum > lastDate) break;
                }
            });
        };

        window.changeFullMonth = (offset) => { viewDate.setMonth(viewDate.getMonth() + offset); renderAttendanceFull(); };
        window.goTodayFull = () => { viewDate = new Date(); renderAttendanceFull(); };
        renderAttendanceFull();
    })();
</script>