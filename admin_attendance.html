<style>
    /* ìº˜ë¦°ë” í…Œì´ë¸” ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ ë° ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
        .calendar-table thead { display: none; } /* ëª¨ë°”ì¼ì—ì„œ ìš”ì¼ í—¤ë” ìˆ¨ê¹€ */
        #full_att_calendar_body { display: flex; flex-direction: column; gap: 12px; }
        #full_att_calendar_body tr { display: contents; }
        #full_att_calendar_body td { 
            display: block; 
            width: 100% !important; 
            height: auto !important; 
            border: none !important; 
            padding: 0 !important;
        }
        /* ë‚ ì§œê°€ ìˆëŠ” ì…€ë§Œ í‘œì‹œí•˜ê³  ë¹ˆ ì…€ì€ ìˆ¨ê¹€ */
        #full_att_calendar_body td:empty { display: none; }
        
        /* ëª¨ë°”ì¼ ë‚ ì§œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .mobile-date-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .today-highlight {
            border: 2px solid #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1) !important;
        }
    }
</style>

<div class="bg-slate-900/50 p-4 md:p-6 rounded-[2rem] md:rounded-3xl border border-slate-800 shadow-2xl">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
        <h2 class="text-xl font-black text-white flex items-center gap-2">
            <span class="text-blue-500">â– </span> STAFF ATTENDANCE <span class="hidden md:inline">(FULL)</span>
        </h2>
        
        <div class="flex items-center gap-3 bg-slate-800/50 p-1.5 rounded-2xl border border-slate-700/50">
            <button onclick="changeFullMonth(-1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div id="full_att_month" class="text-sm md:text-base font-black text-white min-w-[120px] text-center uppercase tracking-tighter italic"></div>
            <button onclick="changeFullMonth(1)" class="p-2 hover:bg-slate-700 rounded-xl transition-all active:scale-90 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
            </button>
            <button onclick="goTodayFull()" class="ml-1 px-3 py-1.5 bg-blue-600/20 text-blue-400 text-[10px] font-black rounded-lg hover:bg-blue-600 hover:text-white transition-all">TODAY</button>
        </div>
    </div>

    <div class="overflow-x-visible">
        <table class="calendar-table w-full table-fixed md:min-w-[800px]">
            <thead>
                <tr class="text-slate-500 text-[10px] uppercase tracking-widest">
                    <th class="py-4">Sun</th><th class="py-4">Mon</th><th class="py-4">Tue</th>
                    <th class="py-4">Wed</th><th class="py-4">Thu</th><th class="py-4">Fri</th><th class="py-4">Sat</th>
                </tr>
            </thead>
            <tbody id="full_att_calendar_body"></tbody>
        </table>
    </div>
</div>

<script>
    (function() {
        const db = firebase.database();
        let viewDate = new Date();

        window.openEditAttendance = function(name, date, infoEncoded) {
            const info = JSON.parse(decodeURIComponent(infoEncoded));
            const isSpecial = typeof info === 'string';
            
            const currentAttend = isSpecial ? "" : (info.attend || "");
            const currentLeave = isSpecial ? "" : (info.leave || "");
            const currentSpecial = isSpecial ? info : "";

            const titleHtml = `
                <div class="flex flex-col">
                    <span class="text-[10px] text-blue-500 font-black uppercase tracking-widest">Edit Attendance</span>
                    <span class="text-lg font-black text-white">${name} <span class="text-slate-500 text-sm">(${date})</span></span>
                </div>`;

            const bodyHtml = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 ml-1">Standard Status</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <span class="text-[9px] text-slate-600 font-bold ml-1 uppercase">In</span>
                                <input type="text" id="editAttend" placeholder="ATT(8:00)" value="${currentAttend}" 
                                       class="w-full bg-slate-800 text-white text-sm p-4 rounded-2xl border border-slate-700 outline-none focus:ring-2 focus:ring-emerald-500/50">
                            </div>
                            <div class="space-y-1">
                                <span class="text-[9px] text-slate-600 font-bold ml-1 uppercase">Out</span>
                                <input type="text" id="editLeave" placeholder="17:00:00" value="${currentLeave}" 
                                       class="w-full bg-slate-800 text-white text-sm p-4 rounded-2xl border border-slate-700 outline-none focus:ring-2 focus:ring-blue-500/50">
                            </div>
                        </div>
                    </div>
                    <div class="relative py-4">
                        <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-800"></span></div>
                        <div class="relative flex justify-center text-[10px] uppercase font-black text-slate-600"><span class="bg-slate-900 px-4">OR Special Status</span></div>
                    </div>
                    <div>
                        <select id="editSpecial" class="w-full bg-slate-800 text-white text-sm p-4 rounded-2xl border border-slate-700 outline-none focus:ring-2 focus:ring-amber-500/50 cursor-pointer appearance-none">
                            <option value="" ${currentSpecial === "" ? "selected" : ""}>--- NO SPECIAL STATUS ---</option>
                            <option value="WO" ${currentSpecial === "WO" ? "selected" : ""}>WO (Work Out)</option>
                            <option value="PEL" ${currentSpecial === "PEL" ? "selected" : ""}>PEL (Personal Leave)</option>
                            <option value="ANL" ${currentSpecial === "ANL" ? "selected" : ""}>ANL (Annual Leave)</option>
                            <option value="SIL" ${currentSpecial === "SIL" ? "selected" : ""}>SIL (Sick Leave)</option>
                            <option value="OFF" ${currentSpecial === "OFF" ? "selected" : ""}>OFF (Day Off)</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-2 pt-4">
                        <button onclick="window.saveAttendanceEdit('${name}', '${date}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl text-sm transition-all active:scale-95 shadow-lg shadow-blue-900/20 uppercase tracking-widest">Save Changes</button>
                        <button onclick="window.deleteAttendance('${name}', '${date}')" class="w-full text-rose-500 font-bold py-3 rounded-xl text-xs hover:bg-rose-500/10 transition-all uppercase tracking-widest">Delete Record</button>
                    </div>
                </div>`;

            if(window.openAdminCustomModal) {
                window.openAdminCustomModal(titleHtml, bodyHtml);
            } else {
                alert("Modal function not found.");
            }
        };

        window.saveAttendanceEdit = function(name, date) {
            const attend = document.getElementById('editAttend').value.trim();
            const leave = document.getElementById('editLeave').value.trim();
            const special = document.getElementById('editSpecial').value;
            let updateData = special ? special : { attend: attend, leave: leave };

            if(confirm(`Update record for ${name} on ${date}?`)) {
                db.ref(`attendance/${date}/${name}`).set(updateData).then(() => {
                    if(window.closeAdminCustomModal) window.closeAdminCustomModal();
                });
            }
        };

        window.deleteAttendance = function(name, date) {
            if(confirm(`Delete ${name}'s record for ${date}?`)) {
                db.ref(`attendance/${date}/${name}`).remove().then(() => {
                    if(window.closeAdminCustomModal) window.closeAdminCustomModal();
                });
            }
        };

        window.renderAttendanceFull = function() {
            document.getElementById('full_att_month').innerText = viewDate.toLocaleString('en-US', {month:'long', year:'numeric'});
            db.ref('attendance').on('value', snap => {
                const data = snap.val() || {};
                const tbody = document.getElementById('full_att_calendar_body');
                tbody.innerHTML = '';
                
                const year = viewDate.getFullYear(), month = viewDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const todayStr = new Date().toISOString().split('T')[0];
                const isMobile = window.innerWidth <= 768;
                let dateNum = 1;

                for (let i = 0; i < 6; i++) {
                    let row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        let cell = document.createElement('td');
                        
                        if (i === 0 && j < firstDay || dateNum > lastDate) { 
                            row.appendChild(cell); 
                        } else {
                            const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dateNum).padStart(2,'0')}`;
                            const isToday = dStr === todayStr;
                            
                            // ê¸°ë³¸ ë””ìì¸ ë° ëª¨ë°”ì¼ ì „ìš© í´ë˜ìŠ¤ ê²°í•©
                            cell.className = `border border-slate-800 md:h-32 p-2 vertical-top align-top transition-all ${isToday ? 'today-highlight' : ''} ${isMobile ? 'mobile-date-card' : ''}`;
                            
                            // ë‚ ì§œ í—¤ë” ë””ìì¸
                            let content = `
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-[11px] font-black ${isToday ? 'text-blue-400' : 'text-slate-500'}">${dateNum}</span>
                                    ${isToday ? '<span class="text-[8px] bg-blue-600 text-white px-1.5 py-0.5 rounded font-black">TODAY</span>' : ''}
                                </div>`;
                            
                            const dayRecords = data[dStr] || {};
                            const hasRecords = Object.keys(dayRecords).length > 0;

                            if(hasRecords) {
                                Object.entries(dayRecords).forEach(([name, info]) => {
                                    let attHtml = '';
                                    const safeInfo = encodeURIComponent(JSON.stringify(info));

                                    if (typeof info === 'string') {
                                        attHtml = `<span class="px-2 py-0.5 rounded-md bg-amber-500/10 text-amber-500 font-black text-[9px] border border-amber-500/20">${info}</span>`;
                                    } else {
                                        const attend = info.attend || "";
                                        const leave = info.leave || "";
                                        const sClass = attend.includes("LATE") ? "text-rose-500" : (attend.includes("ATT") ? "text-emerald-500" : "text-slate-500");
                                        
                                        attHtml = `
                                            <div class="flex flex-col items-end gap-0.5">
                                                <span class="${sClass} font-black tracking-tighter">â˜€ï¸ ${attend}</span>
                                                ${leave ? `<span class="text-slate-400 font-black tracking-tighter">ğŸŒ™ ${leave}</span>` : ''}
                                            </div>`;
                                    }

                                    content += `
                                        <div onclick="window.openEditAttendance('${name}', '${dStr}', '${safeInfo}')" 
                                             class="flex justify-between items-center text-[10px] mb-1.5 bg-slate-800/80 md:bg-slate-800/40 p-2 md:p-1.5 rounded-xl border border-slate-700/50 gap-2 cursor-pointer hover:bg-slate-700 hover:border-blue-500/50 transition-all active:scale-95 shadow-sm">
                                            <span class="truncate font-black text-slate-200">${name}</span>
                                            ${attHtml}
                                        </div>`;
                                });
                            } else if(isMobile) {
                                content += `<div class="text-[10px] text-slate-700 font-medium italic py-2 text-center">No records</div>`;
                            }

                            cell.innerHTML = content;
                            row.appendChild(cell);
                            dateNum++;
                        }
                    }
                    tbody.appendChild(row);
                    if (dateNum > lastDate) break;
                }
            });
        };

        window.changeFullMonth = (offset) => { viewDate.setMonth(viewDate.getMonth() + offset); renderAttendanceFull(); };
        window.goTodayFull = () => { viewDate = new Date(); renderAttendanceFull(); };
        
        // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ë¦¬ë Œë”ë§ (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ì „í™˜ ëŒ€ì‘)
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(renderAttendanceFull, 250);
        });

        renderAttendanceFull();
    })();
</script>