<style>
    .calendar-table th { padding: 12px 0; color: #64748b; font-size: 0.75rem; text-align: center; font-weight: 800; }
    .calendar-table td { 
        height: 70px; width: 14.28%; border: 1px solid #1e293b; vertical-align: top; padding: 4px; position: relative; transition: background 0.2s;
    }
    .calendar-table td:hover { background-color: #0f172a; }
    .today-highlight { background-color: rgba(37, 99, 235, 0.1); border: 2px solid #3b82f6 !important; z-index: 10; }
    
    .time-label {
        display: block; font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 800;
        padding: 1px 2px; margin-top: 1px; border-radius: 3px; text-align: center;
    }
    
    /* ìƒíƒœë³„ ìƒ‰ìƒ ì •ì˜ */
    .att-color { background-color: rgba(16, 185, 129, 0.15); color: #10b981; } /* Green */
    .late-color { background-color: rgba(244, 63, 94, 0.15); color: #f43f5e; } /* Red */
    .other-color { background-color: rgba(245, 158, 11, 0.15); color: #f59e0b; } /* Yellow */
    
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .out-time { background-color: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.2); }
    .status-time { background-color: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    
    .btn-special { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .nav-btn:hover { background-color: #1e293b; color: #3b82f6; }
</style>


<div class="flex flex-col lg:flex-row gap-8">
    <div class="w-full lg:w-1/3 space-y-6">
        <div>
            <p class="text-slate-500 text-[10px] uppercase font-black tracking-[0.2em] mb-1">Authenticated as</p>
            <h2 id="mainWelcomeMsg" class="text-3xl font-black text-white"></h2>
        </div>

        <section class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Attendance Panel</p>
                <p id="liveDate" class="text-[10px] font-bold text-blue-500 bg-blue-500/10 px-2 py-1 rounded"></p>
            </div>
            
            <div class="space-y-4">
                <div id="timeInputWrapper" class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50 transition-opacity">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Time Selection (24H)</label>
                    <input type="text" id="manualTime" 
                           placeholder="00:00:00"
                           maxlength="8"
                           class="w-full bg-slate-800 text-white text-xl font-black p-3 rounded-xl border border-slate-600 outline-none text-center">
                </div>

                <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Special Status</label>
                    <select id="specialStatus" onchange="toggleInputMode()" class="w-full bg-slate-800 text-white font-bold p-3 rounded-xl border border-slate-600 outline-none cursor-pointer">
                        <option value="">--- REGULAR (IN/OUT) ---</option>
                        <option value="WO">WO (Work Out)</option>
                        <option value="PEL">PEL (Personal Leave)</option>
                        <option value="ANL">ANL (Annual Leave)</option>
                        <option value="HAL">HAL (Half Day Leave)</option>
                        <option value="SIL">SIL (Sick Leave)</option>
                        <option value="SPL">SPL (Special Leave)</option>
                    </select>
                </div>

                <div id="buttonArea" class="grid grid-cols-2 gap-3">
                    <button id="btnIn" onclick="handleAttendance('attend')" class="bg-emerald-600 text-white py-4 rounded-xl text-sm font-black transition active:scale-95">SET IN</button>
                    <button id="btnOut" onclick="handleAttendance('leave')" class="bg-rose-600 text-white py-4 rounded-xl text-sm font-black transition active:scale-95">SET OUT</button>
                </div>
                
                <div id="specialButtonArea" class="hidden">
                    <button onclick="handleSpecialStatus()" class="btn-special w-full bg-blue-600 text-white py-4 rounded-xl text-sm font-black transition active:scale-95 shadow-lg shadow-blue-900/20">SAVE SPECIAL STATUS</button>
                </div>
            </div>

            <div id="attendanceLog" class="mt-6 p-4 bg-black/30 rounded-xl text-center text-xs font-bold text-slate-400 italic">No records</div>
        </section>
    </div>

    <div class="flex-1">
        <section class="bg-slate-900 p-5 md:p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl h-full">
            <div class="flex justify-between items-center mb-6 px-2">
                <div class="flex items-center gap-4">
                    <div id="currentMonthYear" class="text-lg font-black text-white italic underline decoration-blue-500 underline-offset-8"></div>
                    <div class="flex bg-slate-800 rounded-lg p-1">
                        <button onclick="changeMonth(-1)" class="nav-btn px-2 py-1 text-slate-400 transition rounded-md text-xs font-black">&lt; PREV</button>
                        <button onclick="goToday()" class="nav-btn px-2 py-1 text-blue-400 transition rounded-md text-xs font-black mx-1">TODAY</button>
                        <button onclick="changeMonth(1)" class="nav-btn px-2 py-1 text-slate-400 transition rounded-md text-xs font-black">NEXT &gt;</button>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] text-slate-500 font-bold">STD: <span id="displayStdTime">--:--</span></span>
                    <div class="w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse"></div>
                </div>
            </div>
            <div class="overflow-x-auto no-scrollbar rounded-xl border border-slate-800">
                <table class="calendar-table w-full border-collapse bg-slate-900/50 text-xs">
                    <thead><tr class="bg-slate-800/30"><th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr></thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>
        </section>
    </div>
</div>


<script>
// 1. ìì¹´ë¥´íƒ€ ì‹œê°„ ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ìˆ˜ì •
function getJakartaDate() {
    const now = new Date();
    // Intl ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ìì¹´ë¥´íƒ€ ì‹œê°„ëŒ€ì˜ ì •í™•í•œ ë‚ ì§œ/ì‹œê°„ ë¬¸ìì—´ ìƒì„±
    const jakartaStr = now.toLocaleString("en-US", {timeZone: "Asia/Jakarta"});
    return new Date(jakartaStr);
}

    (function() {
        const user = sessionStorage.getItem('loggedInUser');
        document.getElementById('mainWelcomeMsg').innerText = user;
        const db = firebase.database();
        
        let now = getJakartaDate(); 
        let viewDate = new Date(now);

// 2. todayStr ìƒì„± ë°©ì‹ ë³€ê²½ (ì¤‘ìš”!)
    // ISOStringì„ ì“°ì§€ ì•Šê³  ìì¹´ë¥´íƒ€ ì‹œê°„ì˜ ì—°/ì›”/ì¼ì„ ì§ì ‘ ì¡°í•©í•©ë‹ˆë‹¤.
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const todayStr = `${y}-${m}-${d}`;
        let standardTime = "";

        const btnIn = document.getElementById('btnIn');
        const timeInput = document.getElementById('manualTime');

        // (1) ì‹¤ì‹œê°„ ìì¹´ë¥´íƒ€ íƒ€ì´ë¨¸ ì„¤ì •
        function updateLiveTime() {
            // ì‚¬ìš©ìê°€ ì…ë ¥ ì¤‘ì¼ ë•ŒëŠ” íƒ€ì´ë¨¸ ì •ì§€
            if (document.activeElement === timeInput) return;
            
            const liveNow = getJakartaDate();
            const hh = String(liveNow.getHours()).padStart(2, '0');
            const mm = String(liveNow.getMinutes()).padStart(2, '0');
            const ss = String(liveNow.getSeconds()).padStart(2, '0');
            timeInput.value = `${hh}:${mm}:${ss}`;
        }
        const timerInterval = setInterval(updateLiveTime, 1000);
        updateLiveTime();

        // (2) ì…ë ¥ ë§ˆìŠ¤í¬ (HH:mm:ss)
        timeInput.addEventListener('input', function(e) {
            let v = e.target.value.replace(/[^0-9]/g, '');
            if (v.length >= 3 && v.length <= 4) {
                v = v.substring(0, 2) + ":" + v.substring(2, 4);
            } else if (v.length >= 5) {
                v = v.substring(0, 2) + ":" + v.substring(2, 4) + ":" + v.substring(4, 6);
            }
            e.target.value = v;
        });

        // Firebase ì„¤ì • ë¡œë“œ
        db.ref('settings/standardTime').on('value', (snap) => {
            const val = snap.val();
            if(val) {
                standardTime = val;
                document.getElementById('displayStdTime').innerText = standardTime;
                if(btnIn) btnIn.disabled = false;
            }
        });

        // (3) ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
        function isValidTime(t) {
            if(!t) return false;
            return /^([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/.test(t);
        }

        // (4) ì¶œí‡´ê·¼ ì²˜ë¦¬ í•¨ìˆ˜ (í†µí•© ë° ì¤‘ë³µ ì œê±°)
  // (4) ì¶œí‡´ê·¼ ì²˜ë¦¬ í•¨ìˆ˜
        window.handleAttendance = function(type) {
            if (!type || typeof type !== 'string') return;

            const inputTime = timeInput.value;
            
            if(!isValidTime(inputTime)) {
                alert("Please enter a valid time (HH:mm:ss). Example: 14:30:05");
                return;
            }

            // 1. í˜„ì¬ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¨¼ì € í™•ì¸
            db.ref('attendance/' + todayStr + '/' + user).once('value', (snap) => {
                const currentData = snap.val() || {};

                // 2. SET IN(attend) í´ë¦­ ì‹œ ì´ë¯¸ ê°’ì´ ìˆëŠ”ì§€ ì²´í¬
                if (type === 'attend' && currentData.attend) {
                    alert("Attendance time has already been set. Changes are not allowed.");
                    return;
                }

                // 3. ì§€ê° íŒë³„ ë¡œì§ (SET IN ì „ìš©)
                let finalVal = inputTime;
                if(type === 'attend') {
                    if(!standardTime) {
                        alert("Standard time is loading...");
                        return;
                    }
                    const [iHH, iMM, iSS] = inputTime.split(':').map(Number);
                    const [sHH, sMM] = standardTime.split(':').map(Number);
                    const stdMinutes = sHH * 60 + sMM;
                    const inputMinutes = iHH * 60 + iMM;
                    
                    if (inputMinutes < stdMinutes || (inputMinutes === stdMinutes && iSS === 0)) {
                        finalVal = `ATT(${inputTime})`;
                    } else {
                        finalVal = `LATE(${inputTime})`;
                    }
                }

                // 4. ì €ì¥ í™•ì¸ ë° ì‹¤í–‰ (SET OUTì€ ìœ„ ì²´í¬ë¥¼ ê±°ì¹˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê³„ì† ì—…ë°ì´íŠ¸ ê°€ëŠ¥)
                if(confirm(`Update ${type.toUpperCase()} to ${finalVal}?`)) {
                    db.ref('attendance/' + todayStr + '/' + user).update({ [type]: finalVal })
                    .then(() => alert("Success."));
                }
            });
        };



        // UI ì—…ë°ì´íŠ¸ ë° ë‹¬ë ¥ ë¡œì§
        document.getElementById('liveDate').innerText = now.toLocaleDateString('en-US', { 
            month: 'short', day: 'numeric', weekday: 'short', timeZone: 'Asia/Jakarta' 
        }).toUpperCase();

// JSì˜ toggleInputMode í•¨ìˆ˜ë¥¼ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
    window.toggleInputMode = function() {
        const status = document.getElementById('specialStatus').value;
        const timeInputWrapper = document.getElementById('timeInputWrapper');
        const btnArea = document.getElementById('buttonArea');
        const specialBtnArea = document.getElementById('specialButtonArea');

        if(status !== "") {
            // íŠ¹ë³„ ìƒíƒœ ì„ íƒ ì‹œ: ì‹œê°„ ì…ë ¥ì°½ë§Œ ë¹„í™œì„±í™”
            timeInputWrapper.classList.add('opacity-30', 'pointer-events-none');
            btnArea.classList.add('hidden');
            specialBtnArea.classList.remove('hidden');
        } else {
            // ì¼ë°˜ ìƒíƒœ ì‹œ: ëª¨ë‘ ì›ë³µ
            timeInputWrapper.classList.remove('opacity-30', 'pointer-events-none');
            btnArea.classList.remove('hidden');
            specialBtnArea.classList.add('hidden');
        }
    };

        window.handleSpecialStatus = function() {
            const status = document.getElementById('specialStatus').value;
            if(!status) return;
            if(confirm(`Set status to ${status}?`)) {
                db.ref('attendance/' + todayStr + '/' + user).set(status)
                .then(() => {
                    alert("Success.");
                    document.getElementById('specialStatus').value = "";
                    toggleInputMode();
                });
            }
        };

window.goToday = function() {
    viewDate = getJakartaDate(); // ë·° ë‚ ì§œë¥¼ í˜„ì¬ ìì¹´ë¥´íƒ€ ì‹œê°„ìœ¼ë¡œ ì´ˆê¸°í™”
    renderCalendar();
};

        window.changeMonth = function(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderCalendar();
        };

function renderCalendar() {
        const year = viewDate.getFullYear(), month = viewDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        
        document.getElementById('currentMonthYear').innerText = 
            viewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();
        
        db.ref('attendance').off();
        db.ref('attendance').on('value', (snap) => {
            const data = snap.val() || {};
            const tbody = document.getElementById('calendarBody');
            tbody.innerHTML = '';
            
            let dateCounter = 1;
            for (let i = 0; i < 6; i++) {
                let row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    let cell = document.createElement('td');
                    if (i === 0 && j < firstDay || dateCounter > lastDate) {
                        row.appendChild(cell);
                    } else {
                        const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dateCounter).padStart(2, '0')}`;
                        const rec = data[dStr] ? data[dStr][user] : null;
                        if (dStr === todayStr) cell.classList.add('today-highlight');
                        
                        let content = `<div class="text-[9px] font-black text-slate-500 opacity-50 ml-1 mt-1">${dateCounter}</div>`;
                        
                        if (rec) {
                            if (typeof rec === 'string') {
                                // Special Status (WO, PEL ë“±) ì²˜ë¦¬
                                content += `<span class="time-label other-color mt-2">${rec}</span>`;
                            } else {
                                // IN (Attend) ì²˜ë¦¬: ë°ì´í„°ê°€ ì—†ì–´ë„ ì´ëª¨í‹°ì½˜ì€ í•­ìƒ í‘œì‹œ
                                let attendText = rec.attend ? rec.attend : "";
                                let attendColor = "other-color"; 
                                if(attendText.includes("ATT")) attendColor = "att-color";
                                else if(attendText.includes("LATE")) attendColor = "late-color";
                                
                                content += `<span class="time-label ${attendColor}">â˜€ï¸ ${attendText}</span>`;

                                // OUT (Leave) ì²˜ë¦¬: ë°ì´í„°ê°€ ì—†ì–´ë„ ì´ëª¨í‹°ì½˜ì€ í•­ìƒ í‘œì‹œ
                                let leaveText = rec.leave ? rec.leave : "";
                                content += `<span class="time-label out-time">ğŸŒ™ ${leaveText}</span>`;
                            }
                        } else {
                            // ë°ì´í„° ìì²´ê°€ ì—†ëŠ” ë‚ ë„ ì´ëª¨í‹°ì½˜ í‹€ ìœ ì§€ (ì„ íƒ ì‚¬í•­)
                            // ë§Œì•½ ì•„ì˜ˆ ë¹ˆ ë‚ ì€ ì´ëª¨í‹°ì½˜ë„ ì•ˆ ë³´ì´ê²Œ í•˜ë ¤ë©´ ì´ else ë¬¸ì€ ë¹„ì›Œë‘ì…”ë„ ë©ë‹ˆë‹¤.
                        }
                        
                        cell.innerHTML = content;
                        row.appendChild(cell); 
                        dateCounter++;
                    }
                }
                tbody.appendChild(row);
                if (dateCounter > lastDate) break; 
            }
        });
    }


        renderCalendar();
    })();
</script>