<style>
    .calendar-table th { padding: 12px 0; color: #64748b; font-size: 0.75rem; text-align: center; font-weight: 800; }
    
    /* [ìˆ˜ì •] ì…€ ë†’ì´ë¥¼ ê°€ë³€ì ìœ¼ë¡œ ë³€ê²½ */
    .calendar-table td { 
        min-height: 100px; 
        height: auto; 
        width: 14.28%; 
        border: 1px solid #1e293b; 
        vertical-align: top; 
        padding: 6px; 
        position: relative; 
        transition: background 0.2s;
    }
    .calendar-table td:hover { background-color: #0f172a; }
    .today-highlight { background-color: rgba(37, 99, 235, 0.1); border: 2px solid #3b82f6 !important; z-index: 10; }
    
    /* [ìˆ˜ì •] í…ìŠ¤íŠ¸ê°€ ì˜ë¦¬ì§€ ì•Šê³  ë³´ì´ê³  ì´ë¦„ê³¼ ì‹œê°„ì´ ì ì ˆíˆ ë°°ì¹˜ë˜ë„ë¡ ê°œì„  */
    .time-label {
        display: block; font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 800;
        padding: 2px 4px; margin-top: 2px; border-radius: 4px; text-align: left;
        line-height: 1.2; word-break: break-all;
    }
    
    .att-color { background-color: rgba(16, 185, 129, 0.15); color: #10b981; } 
    .late-color { background-color: rgba(244, 63, 94, 0.15); color: #f43f5e; } 
    .other-color { background-color: rgba(245, 158, 11, 0.15); color: #f59e0b; } 
    .out-time { background-color: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.2); }

    /* [ìˆ˜ì •] ìŠ¤íƒœí”„ ë¦¬ìŠ¤íŠ¸ê°€ ì…€ì„ ë°€ì–´ë‚´ë„ë¡ ì„¤ì • (ê³ ì • ë†’ì´ ì œê±°) */
    .staff-list-wrapper {
        display: flex; flex-direction: column; gap: 3px; margin-top: 4px;
    }

    /* [ì¶”ê°€] ë‹¬ë ¥ ì˜ì—­ ì „ì²´ì— ìŠ¤í¬ë¡¤ ì ìš© (ë°ì´í„°ê°€ ë§ì•„ì§ˆ ê²½ìš° ëŒ€ì‘) */
    .calendar-scroll-container {
        max-height: 700px; /* í™”ë©´ ë†’ì´ì— ë§ì¶° ì¡°ì • ê°€ëŠ¥ */
        overflow-y: auto;
        overflow-x: auto;
        padding-right: 4px;
    }
    .calendar-scroll-container::-webkit-scrollbar { width: 6px; height: 6px; }
    .calendar-scroll-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

    @media (max-width: 768px) {
        .calendar-table td { min-height: 80px; padding: 4px; }
        .time-label { font-size: 0.55rem; }
        .calendar-scroll-container { max-height: 500px; }
    }

    .btn-special { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .nav-btn:hover { background-color: #1e293b; color: #3b82f6; }

/* [ìˆ˜ì •] ì´ë¦„ê³¼ ì‹œê°„ì„ ì–‘ ëìœ¼ë¡œ ë°°ì¹˜í•˜ê³  ì¤„ë°”ê¿ˆ ë°©ì§€ */
.time-label {
    display: flex; 
    justify-content: space-between; /* ì´ë¦„ ì™¼ìª½, ì‹œê°„ ì˜¤ë¥¸ìª½ ì •ë ¬ */
    align-items: center;
    font-family: 'JetBrains Mono', monospace; 
    font-size: 0.65rem; /* ê°€ë…ì„±ì„ ìœ„í•´ ì‚´ì§ í‚¤ì›€ */
    font-weight: 800;
    padding: 2px 6px; 
    margin-top: 2px; 
    border-radius: 4px; 
    white-space: nowrap; /* ì´ë¦„ì´ ê¸¸ì–´ë„ í•œ ì¤„ë¡œ ìœ ì§€ (í•„ìš”ì‹œ) */
    gap: 8px;
}

/* ì´ë¦„ ë¶€ë¶„ ìŠ¤íƒ€ì¼ */
.staff-name {
    overflow: hidden;
    text-overflow: ellipsis;
    flex-shrink: 1; /* ì´ë¦„ì´ ë„ˆë¬´ ê¸¸ë©´ ì¤„ì–´ë“¤ ìˆ˜ ìˆê²Œ ì„¤ì • */
}

/* ì‹œê°„ ë¶€ë¶„ ìŠ¤íƒ€ì¼ */
.staff-time {
    flex-shrink: 0; /* ì‹œê°„ì€ ì˜ë¦¬ì§€ ì•Šê²Œ ê³ ì • */
    font-variant-numeric: tabular-nums; /* ìˆ«ì í­ ê³ ì • */
}

</style>

<div class="flex flex-col lg:flex-row gap-8">
    <div class="w-full lg:w-1/3 space-y-6">
        <div>
            <p class="text-slate-500 text-[10px] uppercase font-black tracking-[0.2em] mb-1">Authenticated as</p>
            <h2 id="mainWelcomeMsg" class="text-3xl font-black text-white"></h2>
        </div>

        <section class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Attendance Panel</p>
                <p id="liveDate" class="text-[10px] font-bold text-blue-500 bg-blue-500/10 px-2 py-1 rounded"></p>
            </div>
            
            <div class="space-y-4">
                <div id="timeInputWrapper" class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50 transition-opacity">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Time Selection (24H)</label>
                    <input type="text" id="manualTime" placeholder="00:00:00" maxlength="8"
                           class="w-full bg-slate-800 text-white text-xl font-black p-3 rounded-xl border border-slate-600 outline-none text-center">
                </div>

                <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Special Status</label>
                    <select id="specialStatus" onchange="toggleInputMode()" class="w-full bg-slate-800 text-white font-bold p-3 rounded-xl border border-slate-600 outline-none cursor-pointer">
                        <option value="">--- REGULAR (IN/OUT) ---</option>
                        <option value="WO">WO (Work Out)</option>
                        <option value="PEL">PEL (Personal Leave)</option>
                        <option value="ANL">ANL (Annual Leave)</option>
                        <option value="HAL">HAL (Half Day Leave)</option>
                        <option value="SIL">SIL (Sick Leave)</option>
                        <option value="SPL">SPL (Special Leave)</option>
                    </select>
                </div>

                <div id="buttonArea" class="grid grid-cols-2 gap-3">
                    <button id="btnIn" onclick="handleAttendance('attend')" class="bg-emerald-600 text-white py-4 rounded-xl text-sm font-black transition active:scale-95">SET IN</button>
                    <button id="btnOut" onclick="handleAttendance('leave')" class="bg-rose-600 text-white py-4 rounded-xl text-sm font-black transition active:scale-95">SET OUT</button>
                </div>
                
                <div id="specialButtonArea" class="hidden">
                    <button onclick="handleSpecialStatus()" class="btn-special w-full bg-blue-600 text-white py-4 rounded-xl text-sm font-black transition active:scale-95 shadow-lg shadow-blue-900/20">SAVE SPECIAL STATUS</button>
                </div>
            </div>

            <div id="attendanceLog" class="mt-6 p-4 bg-black/30 rounded-xl text-center text-xs font-bold text-slate-400 italic">No records</div>
        </section>
    </div>

    <div class="flex-1 min-w-0">
        <section class="bg-slate-900 p-5 md:p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl h-full">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 px-2 gap-4">
                <div class="flex items-center gap-4">
                    <div id="currentMonthYear" class="text-lg font-black text-white italic underline decoration-blue-500 underline-offset-8"></div>
                    <div class="flex bg-slate-800 rounded-lg p-1">
                        <button onclick="changeMonth(-1)" class="nav-btn px-2 py-1 text-slate-400 transition rounded-md text-xs font-black">&lt; PREV</button>
                        <button onclick="goToday()" class="nav-btn px-2 py-1 text-blue-400 transition rounded-md text-xs font-black mx-1">TODAY</button>
                        <button onclick="changeMonth(1)" class="nav-btn px-2 py-1 text-slate-400 transition rounded-md text-xs font-black">NEXT &gt;</button>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] text-slate-500 font-bold">STD: <span id="displayStdTime">--:--</span></span>
                    <div class="w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse"></div>
                </div>
            </div>
            
            <div class="calendar-scroll-container no-scrollbar rounded-xl border border-slate-800 bg-slate-950/30">
                <table class="calendar-table w-full border-collapse text-xs">
                    <thead><tr class="bg-slate-800/30"><th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr></thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>
        </section>
    </div>
</div>

<script>
// (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ ë™ì¼ ìœ ì§€)
function getJakartaDate() {
    const now = new Date();
    const jakartaStr = now.toLocaleString("en-US", {timeZone: "Asia/Jakarta"});
    return new Date(jakartaStr);
}

(function() {
    const user = sessionStorage.getItem('loggedInUser');
    document.getElementById('mainWelcomeMsg').innerText = user;
    const db = firebase.database();
    
    let now = getJakartaDate(); 
    let viewDate = new Date(now);
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const todayStr = `${y}-${m}-${d}`;
    let standardTime = "";

    const btnIn = document.getElementById('btnIn');
    const timeInput = document.getElementById('manualTime');

    function updateLiveTime() {
        if (document.activeElement === timeInput) return;
        const liveNow = getJakartaDate();
        const hh = String(liveNow.getHours()).padStart(2, '0');
        const mm = String(liveNow.getMinutes()).padStart(2, '0');
        const ss = String(liveNow.getSeconds()).padStart(2, '0');
        timeInput.value = `${hh}:${mm}:${ss}`;
    }
    setInterval(updateLiveTime, 1000);
    updateLiveTime();

    timeInput.addEventListener('input', function(e) {
        let v = e.target.value.replace(/[^0-9]/g, '');
        if (v.length >= 3 && v.length <= 4) v = v.substring(0, 2) + ":" + v.substring(2, 4);
        else if (v.length >= 5) v = v.substring(0, 2) + ":" + v.substring(2, 4) + ":" + v.substring(4, 6);
        e.target.value = v;
    });

    db.ref('settings/standardTime').on('value', (snap) => {
        const val = snap.val();
        if(val) {
            standardTime = val;
            document.getElementById('displayStdTime').innerText = standardTime;
            if(btnIn) btnIn.disabled = false;
        }
    });

    function isValidTime(t) { return /^([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/.test(t); }

window.handleAttendance = function(type) {
    if (!type || typeof type !== 'string') return;
    const inputTime = timeInput.value; // HH:mm:ss í˜•ì‹
    if(!isValidTime(inputTime)) return alert("Invalid Time (HH:mm:ss)");

    // [ìˆ˜ì •] ì…ë ¥ëœ ì‹œê°„ì—ì„œ ì´ˆ ë‹¨ìœ„ë¥¼ ì œì™¸í•˜ê³  HH:mm í˜•ì‹ë§Œ ì¶”ì¶œ
    const timeParts = inputTime.split(':');
    const hmTime = `${timeParts[0]}:${timeParts[1]}`; 

    db.ref('attendance/' + todayStr + '/' + user).once('value', (snap) => {
        const currentData = snap.val() || {};
        if (type === 'attend' && currentData.attend) return alert("Attendance already set.");

        let finalVal = hmTime; // ë¶„ ë‹¨ìœ„ê¹Œì§€ë§Œ ì €ì¥
        if(type === 'attend') {
            const [iHH, iMM] = hmTime.split(':').map(Number);
            const [sHH, sMM] = standardTime.split(':').map(Number);
            const stdMin = sHH * 60 + sMM;
            const inpMin = iHH * 60 + iMM;
            
            // ì§€ê° íŒë³„ (ë¶„ ë‹¨ìœ„ ê¸°ì¤€)
            finalVal = (inpMin <= stdMin) ? `ATT(${hmTime})` : `LATE(${hmTime})`;
        }

        if(confirm(`Update ${type.toUpperCase()} to ${finalVal}?`)) {
            db.ref('attendance/' + todayStr + '/' + user).update({ [type]: finalVal });
        }
    });
};


    document.getElementById('liveDate').innerText = now.toLocaleDateString('en-US', { 
        month: 'short', day: 'numeric', weekday: 'short', timeZone: 'Asia/Jakarta' 
    }).toUpperCase();

    window.toggleInputMode = function() {
        const status = document.getElementById('specialStatus').value;
        const isSpecial = status !== "";
        document.getElementById('timeInputWrapper').classList.toggle('opacity-30', isSpecial);
        document.getElementById('timeInputWrapper').classList.toggle('pointer-events-none', isSpecial);
        document.getElementById('buttonArea').classList.toggle('hidden', isSpecial);
        document.getElementById('specialButtonArea').classList.toggle('hidden', !isSpecial);
    };

    window.handleSpecialStatus = function() {
        const status = document.getElementById('specialStatus').value;
        if(status && confirm(`Set status to ${status}?`)) {
            db.ref('attendance/' + todayStr + '/' + user).set(status).then(() => {
                document.getElementById('specialStatus').value = "";
                toggleInputMode();
            });
        }
    };

    window.goToday = () => { viewDate = getJakartaDate(); renderCalendar(); };
    window.changeMonth = (offset) => { viewDate.setMonth(viewDate.getMonth() + offset); renderCalendar(); };

    function renderCalendar() {
        const year = viewDate.getFullYear(), month = viewDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        document.getElementById('currentMonthYear').innerText = viewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();
        
        db.ref('attendance').on('value', (snap) => {
            const data = snap.val() || {};
            const tbody = document.getElementById('calendarBody');
            tbody.innerHTML = '';
            let dateCounter = 1;
            for (let i = 0; i < 6; i++) {
                let row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    let cell = document.createElement('td');
                    if (i === 0 && j < firstDay || dateCounter > lastDate) {
                        row.appendChild(cell);
                    } else {
                        const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dateCounter).padStart(2, '0')}`;
                        if (dStr === todayStr) cell.classList.add('today-highlight');
                        
                        let cellHTML = `<div class="text-[9px] font-black text-slate-500 opacity-50 ml-1 mt-1">${dateCounter}</div>`;
                        cellHTML += `<div class="staff-list-wrapper">`;

                        if (data[dStr]) {
// renderCalendar í•¨ìˆ˜ ë‚´ Object.entries(data[dStr]).forEach ë¶€ë¶„
Object.entries(data[dStr]).forEach(([staffName, rec]) => {
    // staffName ì „ì²´ ì‚¬ìš© (substring ì œê±°)
    if (typeof rec === 'string') {
        cellHTML += `
            <span class="time-label other-color">
                <span class="staff-name">${staffName}</span>
                <span class="staff-time">${rec}</span>
            </span>`;
    } else {
        if(rec.attend) {
            const c = rec.attend.includes("ATT") ? "att-color" : "late-color";
            const t = rec.attend.split('(')[1]?.replace(')', '').split(':').slice(0, 2).join(':') || rec.attend;
            cellHTML += `
                <span class="time-label ${c}">
                    <span class="staff-name">${staffName}</span>
                    <span class="staff-time">â˜€ï¸${t}</span>
                </span>`;
        }
        if(rec.leave) {
            const t = rec.leave.split('(')[1]?.replace(')', '').split(':').slice(0, 2).join(':') || 
                      rec.leave.split(':').slice(0, 2).join(':');
            cellHTML += `
                <span class="time-label out-time">
                    <span class="staff-name">${staffName}</span>
                    <span class="staff-time">ğŸŒ™${t}</span>
                </span>`;
        }
    }
});

                        }
                        cellHTML += `</div>`;
                        cell.innerHTML = cellHTML;
                        row.appendChild(cell); 
                        dateCounter++;
                    }
                }
                tbody.appendChild(row);
                if (dateCounter > lastDate) break; 
            }
        });
    }
    renderCalendar();
})();
</script>